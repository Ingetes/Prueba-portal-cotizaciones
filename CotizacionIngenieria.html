<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cotizador de ingeniería — Ingetes (v30)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js" defer crossorigin="anonymous"></script>
<style>
:root{--bg:#f7f8fb;--card:#ffffff;--muted:#5b6472;--accent:#2563eb;--text:#0f172a;--line:#e5e7eb}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
header{padding:20px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#ffffff,#f7f8fb)}
h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px}
main{max-width:1200px;margin:0 auto;padding:24px 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 6px 16px rgba(15,23,42,.04)}
label{font-size:14px;color:var(--muted)}label .req{color:#dc2626;margin-left:4px}
textarea{width:100%;min-height:90px;padding:10px;background:#fff;border:1px solid var(--line);border-radius:12px;color:var(--text);resize:vertical}
input[type=text],select,input[type=number]{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
input[type=number]{text-align:right}
button{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:12px;table-layout:auto}
th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:14px;vertical-align:middle}
th{color:#0f172a;font-weight:800;background:#f8fafc}
td.right{text-align:right}.muted{color:var(--muted)}
.grid{display:grid;gap:12px}
@media (min-width:900px){.grid.two{grid-template-columns:repeat(2,1fr)} .grid.three{grid-template-columns:repeat(3,1fr)}}
tfoot td{font-weight:800;background:#fafafa}
.kpi{display:flex;gap:16px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
.pill{background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:6px 12px;font-weight:800}
.warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:10px;padding:8px 12px;margin-top:12px}
.price-view{font-weight:800;color:#0f172a;display:inline-block;min-width:90px}
.price-input{ width:120px; text-align:right; }
.viaticos-fixed{display:grid;grid-template-columns:1fr;gap:4px}
.viaticos-fixed div{display:flex;justify-content:space-between}
.note{display:block;color:#64748b;font-size:12px;margin-bottom:6px}
#loadStatus{margin:12px 0;font-size:13px}
</style>
</head>
<body>
<header><h1>Cotizador de ingeniería — Ingetes</h1></header>
<main>

<!-- Datos generales -->
<div class="card" style="margin-bottom:16px">
  <div class="grid three">
    <div>
      <label for="tipoDoc">Tipo<span class="req">*</span></label>
      <select id="tipoDoc">
        <option value="" selected>-Seleccionar opción-</option>
        <option>Servicio</option><option>Proyecto</option>
      </select>
    </div>
    <div>
      <label for="nombreDoc" id="nombreDocLabel">Nombre del servicio o proyecto<span class="req">*</span></label>
      <input id="nombreDoc" type="text" placeholder="Escriba aqui"/>
    </div>
    <div>
      <label for="ingeniero" id="ingenieroLabel">Ingeniero que ejecuta el servicio o proyecto<span class="req">*</span></label>
      <input id="ingeniero" type="text" placeholder="Escriba aqui"/>
    </div>
  </div>
  <div class="grid" style="margin-top:12px">
    <div>
      <label for="alcance" id="alcanceLabel">Alcance del servicio o proyecto<span class="req">*</span></label>
      <textarea id="alcance" placeholder="Describe el alcance del servicio o del proyecto..."></textarea>
    </div>
  </div>

  <div id="loadStatus" class="muted">Cargando lista de precios desde <b>ListaPreciosIngenieria.xlsx</b>…</div>
  <div id="fallbackWrap" style="display:none;gap:8px" class="grid two">
    <div class="warn">No se pudo leer <b>ListaPreciosIngenieria.xlsx</b> automáticamente. Cárgalo manualmente aquí:</div>
    <div><input type="file" id="filePicker" accept=".xlsx,.xls"/></div>
  </div>
</div>

<!-- Tabla principal -->
<div class="card">
  <table id="tabla">
    <thead>
      <tr>
        <th>Descripción</th>
        <th style="width:190px">Opción</th>
        <th style="width:220px">Condición</th>
        <th class="right" style="width:180px">Precio</th>
        <th class="right" style="width:120px">Días</th>
        <th class="right" style="width:140px">Subtotal</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr><td colspan="5">Subtotal</td><td class="right"><span id="subtotalView">$ 0</span></td></tr>
<tr>
  <td colspan="5">
    Imprevistos (
    <input id="impPct" type="number" min="0" step="0.01" value="10" style="width:60px;text-align:right"> %)
  </td>
  <td class="right"><span id="imprevView">$ 0</span></td>
</tr>

      <tr><td colspan="5">Total</td><td class="right"><span id="totalView">$ 0</span></td></tr>
    </tfoot>
  </table>
  <div class="kpi">
    <div class="muted">Total viáticos:</div><div class="pill" id="pillViaticos">$ 0</div>
    <div class="muted">Subtotal:</div><div class="pill" id="pillSubtotal">$ 0</div>
    <div class="muted" id="pillImprevLabel">Imprevistos (10%):</div><div class="pill" id="pillImprev">$ 0</div>
    <div class="muted">Total</div><div class="pill" id="pillTotal">$ 0</div>
  </div>
</div>

<div id="validacion" class="warn" style="display:none;"></div>
<div class="actions" style="justify-content:flex-end"><button id="btnDescargar">Descargar</button></div>

</main>

<script>
/* =================== CONFIG VISIBLE =================== */
const DESCS = [
  "Programación","Visualización","Configuración","Especializados","Planos",
  "Pruebas FAT","Pruebas SAT (PLC/CCM/HMI)","Puesta en marcha", "Puesta en marcha nocturno", 
  "Capacitación de operación","Elaboración e impr. manual","Dossier técnico",
  "Días de fin de semana","Viáticos"
];

const EDITABLE_PRICE = new Set(["Planos","Elaboración e impr. manual","Dossier técnico"]);

// Filas que usan precio MÁXIMO entre categorías (misma condición)
const DEPENDIENTES = new Set([
  "Pruebas FAT","Pruebas SAT (PLC/CCM/HMI)","Puesta en marcha",
  "Puesta en marcha nocturno", "Capacitación de operación","Días de fin de semana"
]);

const CATEGORIAS = ["Programación","Visualización","Configuración","Especializados"];

const OPTIONS_MAP = {
  "Programación": ["-Seleccionar opción-","Micro automatización (S7-1200, LOGO)","Automatización","Servos"],
  "Visualización": ["-Seleccionar opción-","Basic Panels, LOGO Panels","Paneles Comfort","(SCADA, WinCC TIA.)"],
  "Configuración": ["-Seleccionar opción-","Comunicaciones","V20","G120","Sistemas de pesaje"],
  "Especializados": ["-Seleccionar opción-","Analítica de gases","(Instrumentación, caudal)","(Instrumentación, presión, temperatura, nivel, por equipo)"]
};
const COND_2  = ["-Seleccionar opción-","Diurno lun- vier campo Bogotá","Diurno lun-vier campo fuera Bogotá"];
const COND_3  = ["-Seleccionar opción-","Diurno lun- viernes, OFC","Medio día, diurno lun- vier"];
const COND_4  = ["-Seleccionar opción-","Diurno lun- vier campo Bogotá","Diurno lun-vier campo fuera Bogotá","Nocturno lun-vier/hora"];
const COND_WK = ["-Seleccionar opción-","Fin de semana diurno bog","Fin de semana diurno fuera bog","Fin de semana nocturno/ hora"];

const COND_MAP = {
  "Programación": COND_3,
  "Visualización": COND_3,
  "Configuración": COND_3,
  "Especializados": COND_3,
  "Pruebas FAT": COND_3,
  "Pruebas SAT (PLC/CCM/HMI)":COND_2, 
  "Puesta en marcha": COND_2,
  "Capacitación de operación": COND_4,
  "Días de fin de semana": COND_WK
};

/* ====== Etiquetas Servicio/Proyecto ====== */
const tipoSel = document.getElementById('tipoDoc');
const nombreLabel = document.getElementById('nombreDocLabel');
const ingenieroLabel = document.getElementById('ingenieroLabel');
const alcanceLabel = document.getElementById('alcanceLabel');
const nombreInp = document.getElementById('nombreDoc');
const ingenieroInp = document.getElementById('ingeniero');
const alcanceInp = document.getElementById('alcance');

function refrescarEtiquetas() {
  const t = tipoSel.value;
  if (t === 'Proyecto') {
    nombreLabel.innerHTML = 'Nombre del proyecto<span class="req">*</span>';
    ingenieroLabel.innerHTML = 'Ingeniero que ejecuta el proyecto<span class="req">*</span>';
    alcanceLabel.innerHTML = 'Alcance del proyecto<span class="req">*</span>';
    nombreInp.placeholder = 'Escriba aqui';
    ingenieroInp.placeholder = 'Escriba aqui';
    alcanceInp.placeholder = 'Describe el alcance del proyecto...';
  } else if (t === 'Servicio') {
    nombreLabel.innerHTML = 'Nombre del servicio<span class="req">*</span>';
    ingenieroLabel.innerHTML = 'Ingeniero que ejecuta el servicio<span class="req">*</span>';
    alcanceLabel.innerHTML = 'Alcance del servicio<span class="req">*</span>';
    nombreInp.placeholder = 'Escriba aqui';
    ingenieroInp.placeholder = 'Escriba aqui';
    alcanceInp.placeholder = 'Describe el alcance del servicio...';
  } else {
    nombreLabel.innerHTML = 'Nombre del servicio o proyecto<span class="req">*</span>';
    ingenieroLabel.innerHTML = 'Ingeniero que ejecuta el servicio o proyecto<span class="req">*</span>';
    alcanceLabel.innerHTML = 'Alcance del servicio o proyecto<span class="req">*</span>';
    nombreInp.placeholder = 'Escriba aqui';
    alcanceInp.placeholder = 'Describe el alcance del servicio o del proyecto...';
  }
}
tipoSel.addEventListener('change', ()=>{ refrescarEtiquetas(); updateDependentRows(); });
refrescarEtiquetas();

/* =================== LOOKUP DE PRECIOS DESDE EXCEL =================== */
let PRICE_LOOKUP = new Map();
let VIAT_FIXED = { alimentacion:0, transporte:0, hospedaje:0 };

function norm(s){
  return (s??'').toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toLowerCase().replace(/\s+/g,' ').trim()
    .replace(/[“”"']/g,'').replace(/\s*-\s*/g,'-');
}
function canonCond(s){
  let t = norm(s);
  t = t.replace(/lun-\s*vie(?!r)/g, 'lun- vier');
  t = t.replace(/\s*,\s*/g, ', ').replace(/\s*\/\s*/g, '/ ');
  t = t.replace(/bogota/g,'bogota');
  return t;
}
const DESC_CANON = [
  {keys:['programacion'], target:'Programación'},
  {keys:['visualizacion','visualización'], target:'Visualización'},
  {keys:['configuracion','configuración'], target:'Configuración'},
  {keys:['especializados'], target:'Especializados'},
  {keys:['planos'], target:'Planos'},
  {keys:['pruebas fat'], target:'Pruebas FAT'},
  {keys:['pruebas sat'], target:'Pruebas SAT (PLC/CCM/HMI)'},
  {keys:['puesta en marcha'], target:'Puesta en marcha'},
  {keys:['capacitacion de operacion','capacitación de operación'], target:'Capacitación de operación'},
  {keys:['dias de fin de semana','días de fin de semana'], target:'Días de fin de semana'},
  {keys:['viaticos','viáticos'], target:'Viáticos'},
  // Elaboración e impr. manual (acepta "imp." o variaciones)
  { keys: [
      'elaboracion e impr', 'elaboración e impr',
      'elaboracion e imp',  'elaboración e imp',   // <- clave: “imp.” sin r
      'elaboracion manual', 'elaboración manual',
      'imp. manual', 'impr. manual'
    ],
    target: 'Elaboración e impr. manual'
  },

  // Dossier técnico (acepta “dossier” a secas y variantes)
  { keys: [
      'dossier tecnico','dossier técnico','dossier',
      'libro ingenieria y back up','libro ingenieria','backup'
    ],
    target: 'Dossier técnico'
  },

];
function canonDesc(s){
  const n = norm(s);
  let n2 = n.replace(/\bimp\.?\b/g,'impr')   // "imp." → "impr"
            .replace(/\bmanuales?\b/g,'manual');
  for (const {keys,target} of DESC_CANON) {
    for (const k of keys) {
      if (n2.includes(k)) return target;
    }
  }
  return s;
}
function setPrice(desc,opt,cond,price){
  const d = canonDesc(desc);
  const key = norm(d)+'|'+(norm(opt)||'—')+'|'+canonCond(cond);
  PRICE_LOOKUP.set(key, Number(price)||0);
  if(!cond){
    PRICE_LOOKUP.set(norm(d)+'|'+(norm(opt)||'—')+'|', Number(price)||0);
  }
}
function findPrice(desc,opt,cond){
  const d = canonDesc(desc);
  const variants = [canonCond(cond), '', '—'];
  for(const v of variants){
    const key = norm(d)+'|'+(norm(opt)||'—')+'|'+v;
    if(PRICE_LOOKUP.has(key)) return PRICE_LOOKUP.get(key);
  }
  return null;
}

function findAnyPriceForDesc(desc){
  const prefix = norm(canonDesc(desc)) + '|';
  let max = null;
  for(const [k,v] of PRICE_LOOKUP.entries()){
    if(k.startsWith(prefix)){
      const n = Number(v)||0;
      max = (max==null) ? n : Math.max(max,n);
    }
  }
  return max;
}

function detectViaticoLabel(desc,opt,cond){
  const s = (norm(cond)+' '+norm(opt)+' '+norm(desc)).trim();
  if(s.includes('alimentacion')) return 'Alimentación';
  if(s.includes('transporte'))   return 'Transporte';
  if(s.includes('hospedaje'))    return 'Hospedaje';
  return '';
}
function parseHeaderRows(rows){
  const hdr = rows[0].map(x=>norm(x));
  function findIdx(cands){ for(let i=0;i<hdr.length;i++){ if(cands.includes(hdr[i])) return i; } return -1; }
  const iDesc = findIdx(['descripcion','descripción','concepto','item','descrip']);
  const iOpt  = findIdx(['opcion','opción','categoria','opciones','grupo']);
  const iCond = findIdx(['condicion','condición','jornada','modalidad','cond']);
  const iPrice= findIdx(['precio','valor','tarifa','costo','importe']);
  if(iDesc<0 || iPrice<0) throw new Error('No se localizaron columnas mínimas de Descripción/Precio');
  PRICE_LOOKUP = new Map();
  for(let r=1;r<rows.length;r++){
    const desc0 = rows[r]?.[iDesc]; if(!desc0) continue;
    const opt0  = iOpt>=0 ? (rows[r]?.[iOpt]||'') : '';
    let   cond0 = iCond>=0 ? (rows[r]?.[iCond]||'') : '';
    let price  = rows[r]?.[iPrice];
    if(price==='' || price==null) continue;
    if(typeof price==='string'){
      const txt = price.replace(/[^0-9,.\-]/g,'').replace(/\.(?=.*\.)/g,'');
      price = Number(txt.replace(',','.'));
    }
    const descCanon = canonDesc(desc0);
    if(descCanon==='Viáticos' && !cond0){
      const label = detectViaticoLabel(desc0,opt0,cond0);
      if(label){ setPrice(descCanon,'',label,price); continue; }
    }
    setPrice(descCanon,opt0,cond0,price);
  }
  //deriveViaticosFixed();
}
function parseHierarchicalRows(rows){
  let curDesc = null, curOpt = null;
  PRICE_LOOKUP = new Map();
  for(let r=0;r<rows.length;r++){
    const a = rows[r]?.[1]; const b = rows[r]?.[2]; const c = rows[r]?.[3];
    const hasA = a!==undefined && a!==null && a!==''; const hasB = b!==undefined && b!==null && b!==''; const hasC = c!==undefined && c!==null && c!=='';
    if(hasA && !hasB && !hasC){ curDesc = canonDesc(a); curOpt = null; continue; }
    if(hasA && hasB && hasC){
      const maybeDesc = canonDesc(a);
      const simpleSet = new Set(["Pruebas FAT","Pruebas SAT (PLC/CCM/HMI)","Puesta en marcha","Capacitación de operación","Elaboración e impr. manual","Dossier técnico","Días de fin de semana","Planos","Viáticos","Otros"]);
      if(simpleSet.has(maybeDesc)){ curDesc = maybeDesc; curOpt = '—'; setPrice(curDesc,curOpt,b,c); continue; }
      else { curOpt = a; setPrice(curDesc,curOpt,b,c); continue; }
    }
    if(!hasA && hasB && hasC){ setPrice(curDesc, curOpt || '—', b, c); continue; }
  }
  //deriveViaticosFixed();
}
function deriveViaticosFixed(){
  function getv(label){ const p = findPrice('Viáticos','',label); return (p!=null)?p:0; }
  VIAT_FIXED = { alimentacion: getv('Alimentación'), transporte: getv('Transporte'), hospedaje: getv('Hospedaje') };
}

/* Carga Excel */
async function loadPricingFromURL(){
  const url = 'ListaPreciosIngenieria.xlsx?v=' + Date.now();   // cache-buster
  loadStatus.textContent = 'Cargando lista de precios desde ListaPreciosIngenieria.xlsx…';
  try{
    const resp = await fetch(url, { cache: 'no-store' });
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const buf  = await resp.arrayBuffer();
    const wb   = XLSX.read(buf,{type:'array'});
    const sh   = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
    const headerRow = findHeaderRow(rows);
    if (headerRow >= 0) {
      parseHeaderRows(rows.slice(headerRow));  // corta desde la fila de encabezados real
    } else {
      parseHierarchicalRows(rows);
    }
    loadStatus.innerHTML = 'Lista de precios <b>cargada</b> desde <code>ListaPreciosIngenieria.xlsx</code>.';
    applyAllDefaultPrices(); updateViaticosPriceView(); updateDependentRows(); toggleHorasBadgesAll(); recalcTotals();
  }catch(e){
    console.warn(e);
    loadStatus.innerHTML = 'No se pudo leer <code>ListaPreciosIngenieria.xlsx</code> automáticamente.';
    fallbackWrap.style.display='grid';
  }
}
document.getElementById('filePicker')?.addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  const arr = await f.arrayBuffer();
  const wb = XLSX.read(arr,{type:'array'});
  const sh = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
  const headerRow = findHeaderRow(rows);
  if (headerRow >= 0) {
    parseHeaderRows(rows.slice(headerRow));
  } else {
    parseHierarchicalRows(rows);
  }
  loadStatus.innerHTML = 'Lista de precios <b>cargada</b> desde archivo seleccionado.';
  fallbackWrap.style.display='none';
  applyAllDefaultPrices(); updateViaticosPriceView(); updateDependentRows(); toggleHorasBadgesAll(); recalcTotals();
});

/* =================== RENDER UI =================== */
const tbody = document.querySelector('#tabla tbody');
const diasMap = new Map();
const precioMap = new Map();

function renderTable(){
  tbody.innerHTML='';
  DESCS.forEach((desc,i)=>{
    const tr=document.createElement('tr');

    // Descripción
    const tdDesc=document.createElement('td'); tdDesc.textContent=desc; tr.appendChild(tdDesc);

    // Opción
    const tdOpt=document.createElement('td');
    const opts=OPTIONS_MAP[desc];
    if(opts){
      const sel=document.createElement('select');
      opts.forEach((o,idx)=>{ const op=document.createElement('option'); op.value=idx===0?'':o; op.textContent=o; sel.appendChild(op); });
      sel.addEventListener('change',()=>{ applyDefaultPrice(i, desc); updateDependentRows(); recalcRow(i); });
      tdOpt.appendChild(sel);
    }else{
      tdOpt.innerHTML='<span class="muted">—</span>';
    }
    tr.appendChild(tdOpt);

    // Condición
    const tdCond=document.createElement('td');
    const cOpts=COND_MAP[desc];
    if(cOpts){
      const selc=document.createElement('select');
      cOpts.forEach((o,idx)=>{ const op=document.createElement('option'); op.value=idx===0?'':o; op.textContent=o; selc.appendChild(op); });
      selc.addEventListener('change',()=>{ applyDefaultPrice(i, desc); updateDependentRows(); toggleHorasBadgeForRow(i); recalcRow(i); });
      tdCond.appendChild(selc);
    }else{
      tdCond.innerHTML='<span class="muted">—</span>';
    }
    tr.appendChild(tdCond);

    // Precio (editable en algunos casos)
    const tdPrecio=document.createElement('td'); tdPrecio.className='right';

    if(desc==='Viáticos'){
      const wrap=document.createElement('div'); wrap.className='viaticos-fixed';
      // tres inputs para viáticos
      wrap.innerHTML = `
        <div><span>Alimentación</span><input id="v_alim_inp" type="number" min="0" step="1" value="0" class="price-input"/></div>
        <div><span>Transporte</span><input id="v_trans_inp" type="number" min="0" step="1" value="0" class="price-input"/></div>
        <div><span>Hospedaje</span><input id="v_hosp_inp" type="number" min="0" step="1" value="0" class="price-input"/></div>`;
      tdPrecio.appendChild(wrap);

      // listeners para recalcular (precio de viáticos = suma de 3 inputs)
      setTimeout(()=>{
        ["v_alim_inp","v_trans_inp","v_hosp_inp"].forEach(id=>{
          document.getElementById(id)?.addEventListener('input',()=>{
            updateViaticosPriceView(); // actualizar mapa de precios
          });
        });
      },0);

    }else if(EDITABLE_PRICE.has(desc)){
      // precio editable con input
      const inp=document.createElement('input');
      inp.type='number'; inp.min='0'; inp.step='1'; inp.value='0'; inp.className='price-input';
      inp.autocomplete = 'off';
      inp.addEventListener('input',()=>{
        const val = parseFloat(inp.value||'0')||0;
        precioMap.set(i, val);
        recalcRow(i);
      });
      tdPrecio.appendChild(inp);
    }else{
      // solo vista (sin edición)
      const priceView=document.createElement('span'); priceView.className='price-view'; priceView.textContent='$ 0';
      tdPrecio.appendChild(priceView);
    }
    tr.appendChild(tdPrecio);

    // Días (+ badge Horas dinámico)
    const tdDias=document.createElement('td'); tdDias.className='right';
    const note=document.createElement('small'); note.className='note hours-badge'; note.textContent='Horas'; note.style.display='none';
    if (desc === 'Puesta en marcha nocturno') {
      note.style.display = 'inline-block';   // siempre se ve "Horas" en esta fila
    }
    const inDias=document.createElement('input'); inDias.type='number'; inDias.step='1'; inDias.min='0';
    inDias.addEventListener('input',()=>{ const v=parseFloat(inDias.value||'0'); diasMap.set(i,isNaN(v)?0:v); recalcRow(i); });
    tdDias.appendChild(note); tdDias.appendChild(inDias); tr.appendChild(tdDias);

    // Subtotal
    const tdSub=document.createElement('td'); tdSub.className='right';
    const spanSub=document.createElement('span'); spanSub.id='sub_'+i; spanSub.textContent='$ 0'; tdSub.appendChild(spanSub); tr.appendChild(tdSub);

    tbody.appendChild(tr);
  });
}

/* ====== UTILIDADES PARA ÍNDICES Y SELECCIONES ====== */
const ROW_INDEX = DESCS.reduce((acc, d, idx)=> (acc[d]=idx, acc), {});
function getRow(i){ return tbody.children[i]; }
function getSelectedOption(desc){
  const row = getRow(ROW_INDEX[desc]); if(!row) return '';
  const sel = row.querySelector('td:nth-child(2) select'); return sel? (sel.value||'') : '';
}
function getSelectedCondition(desc){
  const row = getRow(ROW_INDEX[desc]); if(!row) return '';
  const sel = row.querySelector('td:nth-child(3) select'); return sel? (sel.value||'') : '';
}

/* ====== HORAS badge para NOCTURNO ====== */
function isNocturno(cond){ return norm(cond) === 'nocturno lun-vier/hora'; }
function toggleHorasBadgeForRow(i){
  const row = getRow(i); if(!row) return;
  const selCond = row.querySelector('td:nth-child(3) select');
  const note = row.querySelector('td:nth-child(5) .hours-badge');
  if(!note) return;
  const condVal = selCond ? selCond.value : '';
  note.style.display = isNocturno(condVal) ? 'inline-block' : 'none';
}
function toggleHorasBadgesAll(){ DESCS.forEach((d, i)=> toggleHorasBadgeForRow(i)); }

function findHeaderRow(rows){
  const wantDesc  = ['descripcion','descripción','concepto','item','descrip'];
  const wantPrice = ['precio','valor','tarifa','costo','importe'];
  const maxScan = Math.min(rows.length, 20); // busca en las primeras 20
  for (let r = 0; r < maxScan; r++){
    const hdr = (rows[r]||[]).map(x => norm(x));
    const hasDesc  = hdr.some(h => wantDesc.includes(h));
    const hasPrice = hdr.some(h => wantPrice.includes(h));
    if (hasDesc && hasPrice) return r;
  }
  return -1;
}

/* ====== PRECIO DEPENDIENTE: MÁXIMO entre categorías ====== */
function computeDependentPrice(desc){
  const cond = getSelectedCondition(desc);
  const condCanon = cond || '';
  const valores = [];
  for(const cat of CATEGORIAS){
    const opt = getSelectedOption(cat);
    if(!opt) continue;
    const p = findPrice(cat, opt, condCanon);
    if(p!=null && !isNaN(p)) valores.push(Number(p));
  }
  if(valores.length>0) return Math.max(...valores);

  // Fallback a precio propio
  const row = getRow(ROW_INDEX[desc]);
  const ownOptSel = row?.querySelector('td:nth-child(2) select');
  const ownOpt = ownOptSel? (ownOptSel.value||'') : '';
  const pOwn = findPrice(desc, ownOpt, condCanon);
  return (pOwn!=null)? pOwn : 0;
}

function computeDependentPriceForCond(condStr){
  const valores = [];
  for (const cat of CATEGORIAS){
    const opt = getSelectedOption(cat);
    if (!opt) continue;
    const p = findPrice(cat, opt, condStr);
    if (p != null && !isNaN(p)) valores.push(Number(p));
  }
  return valores.length ? Math.max(...valores) : 0;
}


/* ====== Aplicar precios ====== */
function updateViaticosPriceView(){
  // desactiva autocompletar (opcional)
  document.getElementById('v_alim_inp')?.setAttribute('autocomplete','off');
  document.getElementById('v_trans_inp')?.setAttribute('autocomplete','off');
  document.getElementById('v_hosp_inp')?.setAttribute('autocomplete','off');

  // lee los 3 valores
  const al = parseFloat(document.getElementById('v_alim_inp')?.value || '0') || 0;
  const tr = parseFloat(document.getElementById('v_trans_inp')?.value || '0') || 0;
  const ho = parseFloat(document.getElementById('v_hosp_inp')?.value || '0') || 0;

  const idx = DESCS.indexOf('Viáticos');
  const sum = al + tr + ho;           // precio unitario de viáticos

  if (idx >= 0) {
    precioMap.set(idx, sum);          // guarda precio unitario
    recalcRow(idx);                   // recalcula su subtotal = (sum * días)
  }
}

function applyDefaultPrice(rowIndex, desc){
  const row = tbody.children[rowIndex]; if(!row) return;
  if(desc==='Viáticos'){ updateViaticosPriceView(); return; }

  if (desc === 'Puesta en marcha nocturno') {
    let price = computeDependentPriceForCond('Nocturno lun-vier/hora');
    precioMap.set(rowIndex, price || 0);

    const priceView  = row.querySelector('td:nth-child(4) .price-view');
    const priceInput = row.querySelector('td:nth-child(4) input.price-input');
    if (priceInput) priceInput.value = Math.round(price || 0);
    else if (priceView) priceView.textContent = fmtMoney(price);
    return;
  }

  const selOpt  = row.querySelector('td:nth-child(2) select');
  const selCond = row.querySelector('td:nth-child(3) select');
  const optVal  = selOpt ? selOpt.value : '';
  const condVal = selCond ? selCond.value : '';

  // NUEVO: calcula el precio base
  let price = 0;
  if (DEPENDIENTES.has(desc)) {
    price = computeDependentPrice(desc);
  } else {
    const p = findPrice(desc, optVal, condVal);
    price = (p != null) ? p : 0;
  }

  // Si es fila editable y no hay precio directo, toma el mayor de esa descripción
  if (EDITABLE_PRICE.has(desc) && (!price || isNaN(price))) {
    const any = findAnyPriceForDesc(desc);
    if (any != null) price = any;
  }

  precioMap.set(rowIndex, price || 0);

  const priceView  = row.querySelector('td:nth-child(4) .price-view');
  const priceInput = row.querySelector('td:nth-child(4) input.price-input');

  if (priceInput) {
    priceInput.value = Math.round(price || 0);   // <— PRECARGA EN EL INPUT
  } else if (priceView) {
    priceView.textContent = fmtMoney(price);
  }

}

function applyAllDefaultPrices(){ DESCS.forEach((desc,i)=> applyDefaultPrice(i,desc)); }
function updateDependentRows(){ for(const d of DEPENDIENTES){ const i = ROW_INDEX[d]; if(i!=null) applyDefaultPrice(i, d); } }

/* ====== Cálculos ====== */
const moneyFmt = new Intl.NumberFormat('es-CO',{minimumFractionDigits:0,maximumFractionDigits:0});
function fmtMoney(n){ return '$ ' + moneyFmt.format(Math.round((n||0))); }

function recalcRow(i){
  const desc = DESCS[i];
  let precio = parseFloat(precioMap.get(i)||0);
  let qty = parseFloat(diasMap.get(i)||0);
  const sub = (precio||0)*(qty||0);
  const el  = document.getElementById('sub_'+i); if(el) el.textContent = fmtMoney(sub);
  recalcTotals();
}
function recalcTotals(){
  let subtotal=0;
  DESCS.forEach((desc,i)=>{
    let p = parseFloat(precioMap.get(i)||0);
    let q = parseFloat(diasMap.get(i)||0);
    subtotal += (p||0)*(q||0);
  });
  const idxV = ROW_INDEX['Viáticos'];
  const viatPrecio = parseFloat(precioMap.get(idxV)||0);
  const viatDias   = parseFloat(diasMap.get(idxV)||0);
  const viatTotal  = (viatPrecio||0) * (viatDias||0);
  const pillV = document.getElementById('pillViaticos');
  if (pillV) pillV.textContent = fmtMoney(viatTotal);

const pctEl  = document.getElementById('impPct');
const impPct = parseFloat(pctEl?.value || '10');
const imprev = subtotal * (isNaN(impPct) ? 0 : impPct) / 100;
const total  = subtotal + imprev;

const pillLbl = document.getElementById('pillImprevLabel');
if (pillLbl && !isNaN(impPct)) pillLbl.textContent = `Imprevistos (${impPct}%):`;

  document.getElementById('impPct')?.addEventListener('input', recalcTotals);
  document.getElementById('subtotalView').textContent=fmtMoney(subtotal);
  document.getElementById('imprevView').textContent=fmtMoney(imprev);
  document.getElementById('totalView').textContent=fmtMoney(total);
  document.getElementById('pillSubtotal').textContent=fmtMoney(subtotal);
  document.getElementById('pillImprev').textContent=fmtMoney(imprev);
  document.getElementById('pillTotal').textContent=fmtMoney(total);
}

/* ====== Validación mínimos ====== */
function validar(){
  const faltantes=[];
  if(!document.getElementById('tipoDoc').value) faltantes.push('Tipo');
  if(!document.getElementById('nombreDoc').value.trim()) faltantes.push('Nombre');
  if(!document.getElementById('ingeniero').value.trim()) faltantes.push('Ingeniero');
  if(!document.getElementById('alcance').value.trim()) faltantes.push('Alcance');
  if(faltantes.length){
    const warnBox = document.getElementById('validacion');
    warnBox.style.display='block';
    warnBox.textContent='Completa los siguientes campos antes de descargar: '+faltantes.join(', ')+'.';
    window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
    return false;
  }
  document.getElementById('validacion').style.display='none';
  return true;
}

async function downloadExcelWithFilePicker(blob, fileName) {
  try {
    if ('showSaveFilePicker' in window) {
      const handle = await window.showSaveFilePicker({
        suggestedName: fileName,
        types: [{
          description: 'Archivo Excel',
          accept: {'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']}
        }]
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
      return true;
    }
    return false;
  } catch (err) {
    if (err?.name !== 'AbortError') console.error('Error al guardar:', err);
    return false;
  }
}

function downloadExcelWithFallback(blob, fileName) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = fileName;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

function postDownloadToParent(blob, fileName, mime){
  try{
    if (window.parent && window.parent !== window) {
      if (blob?.arrayBuffer) {
        blob.arrayBuffer().then(buf=>{
          window.parent.postMessage({
            __ingetes_download:true,
            fileName,
            mime: mime || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            buffer: buf
          }, '*');
        });
        return true;
      }
    }
  }catch(_){}
  return false;
}

/* ====== Descargar Excel (solo filas con selección) ====== */
document.getElementById('btnDescargar').addEventListener('click', async ()=>{
  if (!validar()) return;
  const impPct = Number(document.getElementById('impPct')?.value || 10);

  // ===== INGENIERIA: encabezado =====
  const rows = [];
  const tipoVal = document.getElementById('tipoDoc').value || '';
  rows.push(['TIPO']);     rows.push([tipoVal]);
  rows.push(['NOMBRE']);   rows.push([document.getElementById('nombreDoc').value || '']);
  rows.push(['ALCANCE']);  rows.push([document.getElementById('alcance').value || '']);
  rows.push(['INGENIERO QUE EJECUTA ' + (tipoVal || 'SERVICIO/PROYECTO').toUpperCase()]);
  rows.push([document.getElementById('ingeniero').value || '']);
  rows.push([]);
  rows.push(['DESCRIPCIÓN','OPCIÓN','CONDICIÓN','PRECIO','DÍAS','SUBTOTAL']);

  // ===== INGENIERIA: filas con selección (o días > 0) =====
  const dataRows = [];
  DESCS.forEach((desc, i) => {
    const rowEl  = tbody.children[i];
    if (!rowEl) return;

    const selOpt  = rowEl.querySelector('td:nth-child(2) select');
    const selCond = rowEl.querySelector('td:nth-child(3) select');
    const inDias  = rowEl.querySelector('td:nth-child(5) input[type=number]');

    const optOut  = selOpt && selOpt.value ? selOpt.value : '';
    const condOut = selCond && selCond.value ? selCond.value : '';
    const precio  = Number(precioMap.get(i) || 0);
    const qty     = Number((inDias && inDias.value) ? inDias.value : 0);
    const sub     = (precio || 0) * (qty || 0);

    const include = (optOut !== '' || condOut !== '' || qty > 0);
    if (include) dataRows.push([desc, optOut, condOut, precio, qty, sub]);
  });
  dataRows.forEach(r => rows.push(r));

  // ===== INGENIERIA: totales segun la UI =====
  let subtotal = 0;
  DESCS.forEach((desc, i) => {
    const p = Number(precioMap.get(i) || 0);
    const q = Number(diasMap.get(i) || 0);
    subtotal += (p || 0) * (q || 0);
  });
  const imprev = subtotal * 0.10;
  const total  = subtotal + imprev;

  rows.push([]);
  rows.push(['SUBTOTAL', subtotal]);
  rows.push([`IMPREVISTOS (${impPct}%)`, imprev]);
  rows.push(['TOTAL', total]);

  // ====== CONSTRUIR EXCEL con ExcelJS (VENTA igual al Generador) ======
  const wb = new ExcelJS.Workbook();

  // Hoja INGENIERIA (pega el AOA "rows")
  const wsIng = wb.addWorksheet('INGENIERIA');
  rows.forEach(r => wsIng.addRow(r));
  wsIng.columns = [
    { width: 28 },  // DESCRIPCIÓN
    { width: 28 },  // OPCIÓN
    { width: 30 },  // CONDICIÓN
    { width: 14 },  // PRECIO
    { width: 10 },  // DÍAS
    { width: 16 },  // SUBTOTAL
  ];

// === LOCALIZA CABECERA + RANGO Y PONE FÓRMULAS EN INGENIERIA ===

// 1) localizar cabecera y filas de datos en la hoja INGENIERIA (1-based en Excel)
const headerRowIdx0 = rows.findIndex(r => String(r[0]).toUpperCase() === 'DESCRIPCIÓN'); // 0-based en JS
const headerRowIdx  = headerRowIdx0 + 1;   // 1-based en Excel
const firstDataRow  = headerRowIdx + 1;    // primera fila de datos en INGENIERIA
const itemsCount    = dataRows.length;     // cuántas filas exportaste
const lastDataRow   = firstDataRow + itemsCount - 1;  // última fila de datos

// 2) Subtotal por cada renglón: F = D * E
if (itemsCount > 0) {
  for (let r = firstDataRow; r <= lastDataRow; r++) {
    wsIng.getCell(r, 6).value = { formula: `D${r}*E${r}` }; // col F
    wsIng.getCell(r, 6).numFmt = '"$" #,##0';
  }
}

// 3) Filas de totales (línea en blanco + SUBTOTAL + IMPREV + TOTAL)
const subtotalRow  = (itemsCount > 0) ? lastDataRow + 2 : headerRowIdx + 2;
const imprevRow    = subtotalRow + 1;
const totalPlusRow = subtotalRow + 2;

// SUBTOTAL enlazado a la col F
wsIng.getCell(subtotalRow, 2).value = (itemsCount > 0)
  ? { formula: `SUM(F${firstDataRow}:F${lastDataRow})` }
  : 0;
wsIng.getCell(subtotalRow, 2).numFmt = '"$" #,##0';

// IMPREVISTOS 10%
wsIng.getCell(imprevRow, 2).value = { formula: `B${subtotalRow}*(${impPct}/100)` };
wsIng.getCell(imprevRow, 2).numFmt = '"$" #,##0';

// TOTAL + IMPREVISTOS
wsIng.getCell(totalPlusRow, 2).value = { formula: `B${subtotalRow}+B${imprevRow}` };
wsIng.getCell(totalPlusRow, 2).numFmt = '"$" #,##0';


  // ==== Hoja VENTA (formato compacto de 1 fila, sin "DISPONIBILIDAD") ====
const wv = wb.addWorksheet('VENTA');

// Columnas: D..H = [ITEM, CANT, DESCRIPCION, V/UNIT, V/TOTAL]
wv.columns = [
  { width: 3 },   // A ITEM
  { width: 3 },   // B ITEM
  { width: 3 },   // C ITEM
  { width: 6 },   // D ITEM
  { width: 8 },   // E CANT
  { width: 70 },  // F DESCRIPCION
  { width: 18 },  // G V/UNIT
  { width: 18 },  // H V/TOTAL
];

const yellow = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFFFFF00' } };
const thin   = { style:'thin', color:{ argb:'FF000000' } };
const box    = { top:thin, left:thin, bottom:thin, right:thin };

// Banda amarilla D3:H3
wv.mergeCells(3,4,3,8);
for (let c = 4; c <= 8; c++) {
  const cell = wv.getCell(3, c);
  cell.value = '';
  cell.fill  = yellow;
  cell.border= box;
}

// Encabezado D4:H4
const HDR = ['ITEM','CANT','DESCRIPCION','V/UNIT','V/TOTAL'];
for (let i = 0; i < HDR.length; i++) {
  const cell = wv.getCell(4, 4 + i);
  cell.value = HDR[i];
  cell.fill  = yellow;
  cell.font  = { bold:true };
  cell.alignment = { vertical:'middle', horizontal:'center', wrapText:true };
  cell.border = box;
}

// ===== Fila única con todo consolidado (D5:H5) =====
let rr = 5;                             // fila de datos en VENTA
const totalLink = `INGENIERIA!B${totalPlusRow}`; // celda de TOTAL + IMPREVISTOS
const ingStart = firstDataRow;          // primera fila de datos en INGENIERIA (1-based)
const ingEnd   = firstDataRow + itemsCount - 1;

if (itemsCount > 0) {
  // ITEM y CANT (una sola fila)
  wv.getCell(rr,4).value = 1;
  wv.getCell(rr,5).value = 1;
  wv.getCell(rr,4).alignment = { vertical:'middle', horizontal:'center' };
  wv.getCell(rr,5).alignment = { vertical:'middle', horizontal:'center' };

  // DESCRIPCION = TEXTJOIN de todas las descripciones con sus días: "Descripcion - X dias"
  let descExpr = `INGENIERIA!A${ingStart}&" - "&INGENIERIA!E${ingStart}&" dias"`;
  for (let r = ingStart + 1; r <= ingEnd; r++) {
    descExpr += `&CHAR(10)&INGENIERIA!A${r}&" - "&INGENIERIA!E${r}&" dias"`;
  }
  wv.getCell(rr,6).value = { formula: descExpr };
  wv.getCell(rr,6).alignment = { vertical:'top', horizontal:'left', wrapText:true };

  // V/UNIT y V/TOTAL = TOTAL + IMPREVISTOS (mismo valor)
wv.getCell(rr,7).value = { formula: totalLink }; // V/UNIT = TOTAL + IMPREVISTOS
wv.getCell(rr,8).value = { formula: totalLink }; // V/TOTAL = TOTAL + IMPREVISTOS
wv.getCell(rr,7).numFmt = '"$" #,##0';
wv.getCell(rr,8).numFmt = '"$" #,##0';
wv.getCell(rr,7).alignment = { vertical:'middle', horizontal:'right' };
wv.getCell(rr,8).alignment = { vertical:'middle', horizontal:'right' };

  for (let c = 4; c <= 8; c++) wv.getCell(rr, c).border = box;
} else {
  // Sin ítems: fila vacía formateada
  for (let c = 4; c <= 8; c++) {
    const cell = wv.getCell(rr, c);
    cell.value = '';
    cell.border = box;
  }
}

// ===== Fila TOTAL y nota de IVA =====
const last  = rr;
const rowTot = last + 1;

// TOTAL (amarillo) — etiqueta en D..G y suma en H (igual a V/TOTAL de la fila única)
wv.mergeCells(rowTot,4,rowTot,7);
wv.getCell(rowTot,4).value = 'TOTAL';
wv.getCell(rowTot,4).alignment = { horizontal:'right', vertical:'middle' };
wv.getCell(rowTot,4).font = { bold:true };
wv.getCell(rowTot,8).value = itemsCount ? { formula: totalLink } : 0;
wv.getCell(rowTot,8).numFmt = '"$" #,##0';
for (let c = 4; c <= 8; c++) {
  const cell = wv.getCell(rowTot, c);
  cell.fill  = yellow;
  cell.border= box;
}

// IVA NO INCLUIDO (amarillo)
const rowIva = rowTot + 1;
wv.mergeCells(rowIva,4,rowIva,8);
wv.getCell(rowIva,4).value = 'IVA NO INCLUIDO';
wv.getCell(rowIva,4).alignment = { horizontal:'center', vertical:'middle' };
wv.getCell(rowIva,4).font = { bold:true };
for (let c = 4; c <= 8; c++) {
  const cell = wv.getCell(rowIva, c);
  cell.fill  = yellow;
  cell.border= box;
}

  // Calcular fórmulas al abrir
  wb.calcProperties.fullCalcOnLoad = true;

  // ===== Guardar (File Picker -> fallback) =====
  const buf  = await wb.xlsx.writeBuffer({ useStyles:true });
  const blob = new Blob([buf], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const name = 'CotizacionIngenieria.xlsx';

  if (!postDownloadToParent(blob, name)) {
    const ok = await downloadExcelWithFilePicker(blob, name);
    if (!ok) downloadExcelWithFallback(blob, name);
  }
});

/* ====== Init ====== */
renderTable();
loadPricingFromURL();
</script>
</body>
</html>
