<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cotizador de ingeniería — Ingetes (v30)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js" defer crossorigin="anonymous"></script>
<style>
:root{
  --bg:#f6f8fb;          /* gris claro del fondo */
  --card:#ffffff;        /* blanco de las tarjetas */
  --text:#0b1020;        /* texto principal */
  --muted:#6b7280;       /* texto secundario */
  --line:#e5e7eb;        /* bordes suaves */
  --accent:#111827;      /* botón oscuro */
  --radius:16px;
  --border:#e5e7eb;      /* líneas y bordes suaves */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
}

/* Encabezado igual al de Excel */
header{
  padding:35px 16px;
  border-bottom:1px solid var(--line);
  background:#ffffff;
}
header h1{margin:0;font-size:30px;font-weight:800}

/* Contenedor centrado y más estrecho */
main{max-width:1340px;margin:0 auto;padding:24px 16px}

/* Tarjetas */
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:0 6px 18px rgba(0,0,0,.06);
  padding:16px;
  margin-bottom:18px;
}

/* Títulos de sección */
h2{font-size:18px;margin:22px 0 10px 0;color:var(--text);font-weight:700}

/* Formularios */
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input[type=text], select, input[type=number], textarea{
  width:100%;padding:10px 12px;border:1px solid var(--line);
  border-radius:10px;background:#fff;color:var(--text);outline:none;
}
textarea{min-height:90px;resize:vertical}
input:focus,select:focus,textarea:focus{
  border-color:#9aa7b4; box-shadow:0 0 0 3px rgba(2,132,199,.15);
}

/* Botón "Reiniciar" claro (estilo similar al de Word) */
.btn.reset{
  background:#eef1f5;
  color:var(--text);
  border:1px solid var(--border);
}
.btn.reset:hover{ filter:brightness(0.98); }

/* Grillas responsivas como en Excel */
.grid{display:grid;gap:12px}
@media (min-width:900px){
  .grid.two{grid-template-columns:repeat(2,1fr)}
  .grid.three{grid-template-columns:repeat(3,1fr)}
}

/* Totales con el mismo estilo de la cabecera de la tabla */
table tfoot tr td{
  background:#f1f5f9;      /* mismo fondo que el encabezado */
  font-weight:800;         /* negrita como el encabezado */
  border-top:1px solid #e5e7eb;
  border-bottom:1px solid #e5e7eb;
  padding:10px 12px;
}

.btn.primary{
  display:inline-flex;align-items:center;gap:8px;
    padding:10px 14px;border-radius:12px;
    border:1px solid var(--border);
    background:#f3f4f6;color:var(--text);
    cursor:pointer;font-weight:600;
}

/* Borde rojo para campos obligatorios vacíos (igual que Word) */
input.error, select.error, textarea.error{
  border-color:#ef4444 !important;
  box-shadow:0 0 0 3px rgba(239,68,68,.15) !important;
}

/* etiqueta (colspan) a la derecha y valor a la derecha ya existente */
table tfoot tr td:first-child{ text-align:right; }

/* Tabla */
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:14px;vertical-align:middle}
th{font-weight:800;background:#f1f5f9}
td.right{text-align:right}

/* KPIs “pill” */
.kpi{
  display:flex;
  gap:16px;
  flex-wrap:wrap;
  justify-content:center;   /* ← centrado a la mitad (sección 3) */
  margin-top:10px;
}

.pill{background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:6px 12px;font-weight:800}
.muted{color:var(--muted)}
.warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:10px;padding:8px 12px;margin-top:12px}

/* Botón principal oscuro como en Excel/Word */
button{
  background:var(--accent);color:#fff;border:0;border-radius:12px;
  padding:10px 14px;font-weight:700;cursor:pointer
}
.actions{
  display:flex;
  gap:10px;
  justify-content:flex-start; /* ← botones a la derecha */
  margin-top:12px;
}

/* Inputs de precio compactos */
.price-input{width:120px;text-align:right}
.note{display:block;color:#64748b;font-size:12px;margin-bottom:6px}
#loadStatus{margin:12px 0;font-size:13px;color:var(--muted)}
label .req{ color:#dc2626; font-weight:700; }

header .brand{
  font-size: 20px;
  color: var(--muted);
  margin-top: 4px;
}

</style>

</head>
<body>

<header>
  <h1>Cotizador de ingeniería — INGETES</h1>
  <div class="brand">INGETES SAS</div>
</header>

<main>

<!-- Datos generales -->
<div class="card" style="margin-bottom:16px">
  <h2>1) Datos generales</h2>
  <div class="grid two">
    <div>
      <label for="tipoDoc">Tipo <span class="req">*</span></label>
      <select id="tipoDoc"> 
        <option value="" selected>-Seleccionar opción-</option>
        <option>Servicio</option><option>Proyecto</option>
      </select>
    </div>
    <div>
      <label for="cliente" id="clienteLabel">Nombre del cliente <span class="req">*</span></label>
      <input id="cliente" type="text" placeholder="Escriba aquí"/>
    </div>
    <div>
      <label for="nombreDoc" id="nombreDocLabel">Nombre del servicio o proyecto <span class="req">*</span></label>
      <input id="nombreDoc" type="text" placeholder="Escriba aquí"/>
    </div>
    <div>
      <label for="ingeniero" id="ingenieroLabel">Ingeniero que ejecuta el servicio o proyecto <span class="req">*</span></label>
      <input id="ingeniero" type="text" placeholder="Escriba aquí"/>
    </div>
  </div>
  <div class="grid" style="margin-top:12px">
    <div>
      <label for="alcance" id="alcanceLabel">Alcance del servicio o proyecto <span class="req">*</span></label>
      <textarea id="alcance" placeholder="Describe el alcance del servicio o del proyecto..."></textarea>
    </div>
  </div>

<div id="loadStatus" class="muted">Cargando lista de precios desde <b>ListaPreciosIngenieria.xlsx</b>…</div>
  <div id="fallbackWrap" style="display:none;gap:8px" class="grid two">
    <div class="warn">No se pudo leer <b>ListaPreciosIngenieria.xlsx</b> automáticamente. Cárgalo manualmente aquí:</div>
    <div><input type="file" id="filePicker" accept=".xlsx,.xls"/></div>
  </div>
</div>

<!-- Tabla principal -->
<div class="card">
  <h2>2) Items y precios</h2>
  <table id="tabla">
    <thead>
      <tr>
        <th>Descripción</th>
        <th>Opción</th>
        <th>Condición</th>
        <th class="right" style="width:180px">Precio</th>
        <th class="right" style="width:120px">Días</th>
        <th class="right" style="width:140px">Subtotal</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr><td colspan="5">Subtotal</td><td class="right"><span id="subtotalView">$ 0</span></td></tr>
<tr>
  <td colspan="5">
    Imprevistos (
    <input id="impPct" type="number" min="0" step="0.01" value="10" style="width:60px;text-align:right"> %)
  </td>
  <td class="right"><span id="imprevView">$ 0</span></td>
</tr>

      <tr><td colspan="5">Total</td><td class="right"><span id="totalView">$ 0</span></td></tr>
    </tfoot>
  </table>
</div>

<div class="card">
  <h2>3) totales</h2>
  <table id="tabla">
    <tbody></tbody>
  </table>
  <div class="kpi">
    <div class="muted">Total viáticos:</div><div class="pill" id="pillViaticos">$ 0</div>
    <div class="muted">Subtotal:</div><div class="pill" id="pillSubtotal">$ 0</div>
    <div class="muted" id="pillImprevLabel">Imprevistos (10%):</div><div class="pill" id="pillImprev">$ 0</div>
    <div class="muted">Total</div><div class="pill" id="pillTotal">$ 0</div>
  </div>
</div>

<div class="card">
  <h2>4) Generar documento</h2>
  <div class="actions" style="justify-content:flex-start; gap:8px">
  <div id="validacion" class="warn" style="display:none;margin-right:auto;"></div>
  <button id="btnDescargar" class="btn primary" type="button">Descargar</button>
  <button id="btnReset" class="btn reset" type="button">Reiniciar</button>
</div>
</div>

</main>

<script>
/* Pinta de rojo todos los asteriscos '*' dentro de las etiquetas <label> */
window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('label').forEach(l => {
    // evita re-doblar si ya se aplicó
    if (!l.dataset.asterFixed) {
      l.innerHTML = l.innerHTML.replace(/\*/g, '<span class="aster">*</span>');
      l.dataset.asterFixed = '1';
    }
  });
});
/* =================== CONFIG VISIBLE =================== */
const DESCS = [
  "Programación","Visualización","Configuración","Especializados","Planos",
  "Pruebas FAT","Pruebas SAT (PLC/CCM/HMI)","Puesta en marcha", "Puesta en marcha nocturno", 
  "Capacitación de operación","Elaboración e impr. manual","Dossier técnico",
  "Días de fin de semana","Viáticos"
];

const EDITABLE_PRICE = new Set(["Planos","Elaboración e impr. manual","Dossier técnico", "Puesta en marcha" ]);

// Filas que usan precio MÁXIMO entre categorías (misma condición)
const DEPENDIENTES = new Set([
  "Pruebas FAT","Pruebas SAT (PLC/CCM/HMI)","Puesta en marcha",
  "Puesta en marcha nocturno", "Capacitación de operación","Días de fin de semana"
]);

const CATEGORIAS = ["Programación","Visualización","Configuración","Especializados"];

const OPTIONS_MAP = {
  "Programación": ["-Seleccionar opción-","Micro automatización (S7-1200, LOGO)","Automatización","Servos"],
  "Visualización": ["-Seleccionar opción-","Basic Panels, LOGO Panels","Paneles Comfort","(SCADA, WinCC TIA.)"],
  "Configuración": ["-Seleccionar opción-","Comunicaciones","V20","G120","Sistemas de pesaje"],
  "Especializados": ["-Seleccionar opción-","Analítica de gases","(Instrumentación, caudal)","(Instrumentación, presión, temperatura, nivel, por equipo)"]
};
const COND_2  = ["-Seleccionar opción-","Diurno lun- vier campo Bogotá","Diurno lun-vier campo fuera Bogotá"];
const COND_3  = ["-Seleccionar opción-","Diurno lun- viernes, OFC","Medio día, diurno lun- vier"];
const COND_4  = ["-Seleccionar opción-","Diurno lun- vier campo Bogotá","Diurno lun-vier campo fuera Bogotá","Nocturno lun-vier/hora"];
const COND_WK = ["-Seleccionar opción-","Fin de semana diurno bog","Fin de semana diurno fuera bog","Fin de semana nocturno/ hora"];

const COND_MAP = {
  "Programación": COND_3,
  "Visualización": COND_3,
  "Configuración": COND_3,
  "Especializados": COND_3,
  "Pruebas FAT": COND_3,
  "Pruebas SAT (PLC/CCM/HMI)":COND_2, 
  "Puesta en marcha": COND_2,
  "Capacitación de operación": COND_4,
  "Días de fin de semana": COND_WK
};

/* ====== Etiquetas Servicio/Proyecto ====== */
const tipoSel = document.getElementById('tipoDoc');
const nombreLabel = document.getElementById('nombreDocLabel');
const ingenieroLabel = document.getElementById('ingenieroLabel');
const alcanceLabel = document.getElementById('alcanceLabel');
const nombreInp = document.getElementById('nombreDoc');
const ingenieroInp = document.getElementById('ingeniero');
const alcanceInp = document.getElementById('alcance');
const clienteInp = document.getElementById('cliente');

// --- Quitar borde rojo cuando el usuario completa los campos obligatorios ---
const warnBox = document.getElementById('validacion');
function allRequiredFilled(){
  return tipoSel?.value &&
         (nombreInp?.value||'').trim() &&
         (ingenieroInp?.value||'').trim() &&
         (alcanceInp?.value||'').trim() &&
         (clienteInp?.value||'').trim();
}
tipoSel?.addEventListener('change', ()=>{
  if (tipoSel.value) tipoSel.classList.remove('error');
  if (allRequiredFilled() && warnBox){ warnBox.style.display='none'; warnBox.textContent=''; }
});
[nombreInp, ingenieroInp, alcanceInp, clienteInp].forEach(el=>{
  el?.addEventListener('input', ()=>{
    if ((el.value||'').trim()) el.classList.remove('error');
    if (allRequiredFilled() && warnBox){ warnBox.style.display='none'; warnBox.textContent=''; }
  });
});

function refrescarEtiquetas() {
  const t = tipoSel.value;
  if (t === 'Proyecto') {
    nombreLabel.innerHTML = 'Nombre del proyecto <span class="req">*</span>';
    ingenieroLabel.innerHTML = 'Ingeniero que ejecuta el proyecto <span class="req">*</span>';
    alcanceLabel.innerHTML = 'Alcance del proyecto <span class="req">*</span>';
    clienteInp.placeholder = 'Escriba aquí';
    nombreInp.placeholder = 'Escriba aquí';
    ingenieroInp.placeholder = 'Escriba aquí';
    alcanceInp.placeholder = 'Describe el alcance del proyecto...';
  } else if (t === 'Servicio') {
    nombreLabel.innerHTML = 'Nombre del servicio <span class="req">*</span>';
    ingenieroLabel.innerHTML = 'Ingeniero que ejecuta el servicio <span class="req">*</span>';
    alcanceLabel.innerHTML = 'Alcance del servicio <span class="req">*</span>';
    clienteInp.placeholder = 'Escriba aquí';
    nombreInp.placeholder = 'Escriba aquí';
    ingenieroInp.placeholder = 'Escriba aquí';
    alcanceInp.placeholder = 'Describe el alcance del servicio...';
  } else {
    nombreLabel.innerHTML = 'Nombre del servicio o proyecto <span class="req">*</span>';
    ingenieroLabel.innerHTML = 'Ingeniero que ejecuta el servicio o proyecto <span class="req">*</span>';
    alcanceLabel.innerHTML = 'Alcance del servicio o proyecto <span class="req">*</span>';
    clienteInp.placeholder = 'Escriba aquí';
    nombreInp.placeholder = 'Escriba aquí';
    alcanceInp.placeholder = 'Describe el alcance del servicio o del proyecto...';
  }
}
tipoSel.addEventListener('change', ()=>{ refrescarEtiquetas(); updateDependentRows(); });
refrescarEtiquetas();

/* =================== LOOKUP DE PRECIOS DESDE EXCEL =================== */
let PRICE_LOOKUP = new Map();
let VIAT_FIXED = { alimentacion:0, transporte:0, hospedaje:0 };

function norm(s){
  return (s??'').toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toLowerCase().replace(/\s+/g,' ').trim()
    .replace(/[“”"']/g,'').replace(/\s*-\s*/g,'-');
}
function canonCond(s){
  let t = norm(s);
  t = t.replace(/lun-\s*vie(?!r)/g, 'lun- vier');
  t = t.replace(/\s*,\s*/g, ', ').replace(/\s*\/\s*/g, '/ ');
  t = t.replace(/bogota/g,'bogota');
  return t;
}
const DESC_CANON = [
  {keys:['programacion'], target:'Programación'},
  {keys:['visualizacion','visualización'], target:'Visualización'},
  {keys:['configuracion','configuración'], target:'Configuración'},
  {keys:['especializados'], target:'Especializados'},
  {keys:['planos'], target:'Planos'},
  {keys:['pruebas fat'], target:'Pruebas FAT'},
  {keys:['pruebas sat'], target:'Pruebas SAT (PLC/CCM/HMI)'},
  {keys:['puesta en marcha'], target:'Puesta en marcha'},
  {keys:['capacitacion de operacion','capacitación de operación'], target:'Capacitación de operación'},
  {keys:['dias de fin de semana','días de fin de semana'], target:'Días de fin de semana'},
  {keys:['viaticos','viáticos'], target:'Viáticos'},
  // Elaboración e impr. manual (acepta "imp." o variaciones)
  { keys: [
      'elaboracion e impr', 'elaboración e impr',
      'elaboracion e imp',  'elaboración e imp',   // <- clave: “imp.” sin r
      'elaboracion manual', 'elaboración manual',
      'imp. manual', 'impr. manual'
    ],
    target: 'Elaboración e impr. manual'
  },

  // Dossier técnico (acepta “dossier” a secas y variantes)
  { keys: [
      'dossier tecnico','dossier técnico','dossier',
      'libro ingenieria y back up','libro ingenieria','backup'
    ],
    target: 'Dossier técnico'
  },

];
function canonDesc(s){
  const n = norm(s);
  let n2 = n.replace(/\bimp\.?\b/g,'impr')   // "imp." → "impr"
            .replace(/\bmanuales?\b/g,'manual');
  for (const {keys,target} of DESC_CANON) {
    for (const k of keys) {
      if (n2.includes(k)) return target;
    }
  }
  return s;
}
function setPrice(desc,opt,cond,price){
  const d = canonDesc(desc);
  const key = norm(d)+'|'+(norm(opt)||'—')+'|'+canonCond(cond);
  PRICE_LOOKUP.set(key, Number(price)||0);
  if(!cond){
    PRICE_LOOKUP.set(norm(d)+'|'+(norm(opt)||'—')+'|', Number(price)||0);
  }
}
function findPrice(desc,opt,cond){
  const d = canonDesc(desc);
  const variants = [canonCond(cond), '', '—'];
  for(const v of variants){
    const key = norm(d)+'|'+(norm(opt)||'—')+'|'+v;
    if(PRICE_LOOKUP.has(key)) return PRICE_LOOKUP.get(key);
  }
  return null;
}

function findAnyPriceForDesc(desc){
  const prefix = norm(canonDesc(desc)) + '|';
  let max = null;
  for(const [k,v] of PRICE_LOOKUP.entries()){
    if(k.startsWith(prefix)){
      const n = Number(v)||0;
      max = (max==null) ? n : Math.max(max,n);
    }
  }
  return max;
}

function detectViaticoLabel(desc,opt,cond){
  const s = (norm(cond)+' '+norm(opt)+' '+norm(desc)).trim();
  if(s.includes('alimentacion')) return 'Alimentación';
  if(s.includes('transporte'))   return 'Transporte';
  if(s.includes('hospedaje'))    return 'Hospedaje';
  return '';
}
function parseHeaderRows(rows){
  const hdr = rows[0].map(x=>norm(x));
  function findIdx(cands){ for(let i=0;i<hdr.length;i++){ if(cands.includes(hdr[i])) return i; } return -1; }
  const iDesc = findIdx(['descripcion','descripción','concepto','item','descrip']);
  const iOpt  = findIdx(['opcion','opción','categoria','opciones','grupo']);
  const iCond = findIdx(['condicion','condición','jornada','modalidad','cond']);
  const iPrice= findIdx(['precio','valor','tarifa','costo','importe']);
  if(iDesc<0 || iPrice<0) throw new Error('No se localizaron columnas mínimas de Descripción/Precio');
  PRICE_LOOKUP = new Map();
  for(let r=1;r<rows.length;r++){
    const desc0 = rows[r]?.[iDesc]; if(!desc0) continue;
    const opt0  = iOpt>=0 ? (rows[r]?.[iOpt]||'') : '';
    let   cond0 = iCond>=0 ? (rows[r]?.[iCond]||'') : '';
    let price  = rows[r]?.[iPrice];
    if(price==='' || price==null) continue;
    if(typeof price==='string'){
      const txt = price.replace(/[^0-9,.\-]/g,'').replace(/\.(?=.*\.)/g,'');
      price = Number(txt.replace(',','.'));
    }
    const descCanon = canonDesc(desc0);
    if(descCanon==='Viáticos' && !cond0){
      const label = detectViaticoLabel(desc0,opt0,cond0);
      if(label){ setPrice(descCanon,'',label,price); continue; }
    }
    setPrice(descCanon,opt0,cond0,price);
  }
  //deriveViaticosFixed();
}
function parseHierarchicalRows(rows){
  let curDesc = null, curOpt = null;
  PRICE_LOOKUP = new Map();
  for(let r=0;r<rows.length;r++){
    const a = rows[r]?.[1]; const b = rows[r]?.[2]; const c = rows[r]?.[3];
    const hasA = a!==undefined && a!==null && a!==''; const hasB = b!==undefined && b!==null && b!==''; const hasC = c!==undefined && c!==null && c!=='';
    if(hasA && !hasB && !hasC){ curDesc = canonDesc(a); curOpt = null; continue; }
    if(hasA && hasB && hasC){
      const maybeDesc = canonDesc(a);
      const simpleSet = new Set(["Pruebas FAT","Pruebas SAT (PLC/CCM/HMI)","Puesta en marcha","Capacitación de operación","Elaboración e impr. manual","Dossier técnico","Días de fin de semana","Planos","Viáticos","Otros"]);
      if(simpleSet.has(maybeDesc)){ curDesc = maybeDesc; curOpt = '—'; setPrice(curDesc,curOpt,b,c); continue; }
      else { curOpt = a; setPrice(curDesc,curOpt,b,c); continue; }
    }
    if(!hasA && hasB && hasC){ setPrice(curDesc, curOpt || '—', b, c); continue; }
  }
  //deriveViaticosFixed();
}
function deriveViaticosFixed(){
  function getv(label){ const p = findPrice('Viáticos','',label); return (p!=null)?p:0; }
  VIAT_FIXED = { alimentacion: getv('Alimentación'), transporte: getv('Transporte'), hospedaje: getv('Hospedaje') };
}

/* Carga Excel */
async function loadPricingFromURL(){
  const url = 'ListaPreciosIngenieria.xlsx?v=' + Date.now();   // cache-buster
  loadStatus.textContent = 'Cargando lista de precios desde ListaPreciosIngenieria.xlsx…';
  try{
    const resp = await fetch(url, { cache: 'no-store' });
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const buf  = await resp.arrayBuffer();
    const wb   = XLSX.read(buf,{type:'array'});
    const sh   = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
    const headerRow = findHeaderRow(rows);
    if (headerRow >= 0) {
      parseHeaderRows(rows.slice(headerRow));  // corta desde la fila de encabezados real
    } else {
      parseHierarchicalRows(rows);
    }
    loadStatus.innerHTML = 'Lista de precios <b>cargada</b> desde <code>ListaPreciosIngenieria.xlsx</code>.';
    applyAllDefaultPrices(); updateViaticosPriceView(); updateDependentRows(); toggleHorasBadgesAll(); recalcTotals();
  }catch(e){
    console.warn(e);
    fallbackWrap.style.display='grid';
  }
}
document.getElementById('filePicker')?.addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  const arr = await f.arrayBuffer();
  const wb = XLSX.read(arr,{type:'array'});
  const sh = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
  const headerRow = findHeaderRow(rows);
  if (headerRow >= 0) {
    parseHeaderRows(rows.slice(headerRow));
  } else {
    parseHierarchicalRows(rows);
  }
  loadStatus.innerHTML = 'Lista de precios <b>cargada</b> desde archivo seleccionado.';
  fallbackWrap.style.display='none';
  applyAllDefaultPrices(); updateViaticosPriceView(); updateDependentRows(); toggleHorasBadgesAll(); recalcTotals();
});

/* =================== RENDER UI =================== */
const tbody = document.querySelector('#tabla tbody');
const diasMap = new Map();
const precioMap = new Map();

function renderTable(){
  tbody.innerHTML='';
  DESCS.forEach((desc,i)=>{
    const tr=document.createElement('tr');

    // Descripción
    const tdDesc=document.createElement('td'); tdDesc.textContent=desc; tr.appendChild(tdDesc);

    // Opción
    const tdOpt=document.createElement('td');
    const opts=OPTIONS_MAP[desc];
    if(opts){
      const sel=document.createElement('select');
      opts.forEach((o,idx)=>{ const op=document.createElement('option'); op.value=idx===0?'':o; op.textContent=o; sel.appendChild(op); });
      sel.addEventListener('change',()=>{ applyDefaultPrice(i, desc); updateDependentRows(); recalcRow(i); });
      tdOpt.appendChild(sel);
    }else{
      tdOpt.innerHTML='<span class="muted">—</span>';
    }
    tr.appendChild(tdOpt);

    // Condición
    const tdCond=document.createElement('td');
    const cOpts=COND_MAP[desc];
    if(cOpts){
      const selc=document.createElement('select');
      cOpts.forEach((o,idx)=>{ const op=document.createElement('option'); op.value=idx===0?'':o; op.textContent=o; selc.appendChild(op); });
      selc.addEventListener('change',()=>{ applyDefaultPrice(i, desc); updateDependentRows(); toggleHorasBadgeForRow(i); recalcRow(i); });
      tdCond.appendChild(selc);
    }else{
      tdCond.innerHTML='<span class="muted">—</span>';
    }
    tr.appendChild(tdCond);

    // Precio (editable en algunos casos)
    const tdPrecio=document.createElement('td'); tdPrecio.className='right';

    if(desc==='Viáticos'){
      const wrap=document.createElement('div'); wrap.className='viaticos-fixed';
      // tres inputs para viáticos
      wrap.innerHTML = `
        <div><span>Alimentación</span><input id="v_alim_inp" type="number" min="0" step="1" value="0" class="price-input"/></div>
        <div><span>Transporte</span><input id="v_trans_inp" type="number" min="0" step="1" value="0" class="price-input"/></div>
        <div><span>Hospedaje</span><input id="v_hosp_inp" type="number" min="0" step="1" value="0" class="price-input"/></div>`;
      tdPrecio.appendChild(wrap);

      // listeners para recalcular (precio de viáticos = suma de 3 inputs)
      setTimeout(()=>{
        ["v_alim_inp","v_trans_inp","v_hosp_inp"].forEach(id=>{
          document.getElementById(id)?.addEventListener('input',()=>{
            updateViaticosPriceView(); // actualizar mapa de precios
          });
        });
      },0);

    }else if(EDITABLE_PRICE.has(desc)){
      // precio editable con input
      const inp=document.createElement('input');
      inp.type='number'; inp.min='0'; inp.step='1'; inp.value='0'; inp.className='price-input';
      inp.autocomplete = 'off';
      inp.addEventListener('input',()=>{
        const val = parseFloat(inp.value||'0')||0;
        precioMap.set(i, val);
        recalcRow(i);
      });
      tdPrecio.appendChild(inp);
    }else{
      // solo vista (sin edición)
      const priceView=document.createElement('span'); priceView.className='price-view'; priceView.textContent='$ 0';
      tdPrecio.appendChild(priceView);
    }
    tr.appendChild(tdPrecio);

    // Días (+ badge Horas dinámico)
    const tdDias=document.createElement('td'); tdDias.className='right';
    const note=document.createElement('small'); note.className='note hours-badge'; note.textContent='Horas'; note.style.display='none';
    if (desc === 'Puesta en marcha nocturno') {
      note.style.display = 'inline-block';   // siempre se ve "Horas" en esta fila
    }
    const inDias=document.createElement('input'); inDias.type='number'; inDias.step='1'; inDias.min='0';
    inDias.addEventListener('input',()=>{ const v=parseFloat(inDias.value||'0'); diasMap.set(i,isNaN(v)?0:v); recalcRow(i); });
    tdDias.appendChild(note); tdDias.appendChild(inDias); tr.appendChild(tdDias);

    // Subtotal
    const tdSub=document.createElement('td'); tdSub.className='right';
    const spanSub=document.createElement('span'); spanSub.id='sub_'+i; spanSub.textContent='$ 0'; tdSub.appendChild(spanSub); tr.appendChild(tdSub);

    tbody.appendChild(tr);
  });
}

/* ====== UTILIDADES PARA ÍNDICES Y SELECCIONES ====== */
const ROW_INDEX = DESCS.reduce((acc, d, idx)=> (acc[d]=idx, acc), {});
function getRow(i){ return tbody.children[i]; }
function getSelectedOption(desc){
  const row = getRow(ROW_INDEX[desc]); if(!row) return '';
  const sel = row.querySelector('td:nth-child(2) select'); return sel? (sel.value||'') : '';
}
function getSelectedCondition(desc){
  const row = getRow(ROW_INDEX[desc]); if(!row) return '';
  const sel = row.querySelector('td:nth-child(3) select'); return sel? (sel.value||'') : '';
}

/* ====== HORAS badge para NOCTURNO ====== */
function isNocturno(cond){ return norm(cond) === 'nocturno lun-vier/hora'; }
function toggleHorasBadgeForRow(i){
  const row = getRow(i); if(!row) return;
  const selCond = row.querySelector('td:nth-child(3) select');
  const note = row.querySelector('td:nth-child(5) .hours-badge');
  if(!note) return;
  const condVal = selCond ? selCond.value : '';
  note.style.display = isNocturno(condVal) ? 'inline-block' : 'none';
}
function toggleHorasBadgesAll(){ DESCS.forEach((d, i)=> toggleHorasBadgeForRow(i)); }

function findHeaderRow(rows){
  const wantDesc  = ['descripcion','descripción','concepto','item','descrip'];
  const wantPrice = ['precio','valor','tarifa','costo','importe'];
  const maxScan = Math.min(rows.length, 20); // busca en las primeras 20
  for (let r = 0; r < maxScan; r++){
    const hdr = (rows[r]||[]).map(x => norm(x));
    const hasDesc  = hdr.some(h => wantDesc.includes(h));
    const hasPrice = hdr.some(h => wantPrice.includes(h));
    if (hasDesc && hasPrice) return r;
  }
  return -1;
}

/* ====== PRECIO DEPENDIENTE: MÁXIMO entre categorías ====== */
function computeDependentPrice(desc){
  const cond = getSelectedCondition(desc);
  const condCanon = cond || '';
  const valores = [];
  for(const cat of CATEGORIAS){
    const opt = getSelectedOption(cat);
    if(!opt) continue;
    const p = findPrice(cat, opt, condCanon);
    if(p!=null && !isNaN(p)) valores.push(Number(p));
  }
  if(valores.length>0) return Math.max(...valores);

  // Fallback a precio propio
  const row = getRow(ROW_INDEX[desc]);
  const ownOptSel = row?.querySelector('td:nth-child(2) select');
  const ownOpt = ownOptSel? (ownOptSel.value||'') : '';
  const pOwn = findPrice(desc, ownOpt, condCanon);
  return (pOwn!=null)? pOwn : 0;
}

function computeDependentPriceForCond(condStr){
  const valores = [];
  for (const cat of CATEGORIAS){
    const opt = getSelectedOption(cat);
    if (!opt) continue;
    const p = findPrice(cat, opt, condStr);
    if (p != null && !isNaN(p)) valores.push(Number(p));
  }
  return valores.length ? Math.max(...valores) : 0;
}


/* ====== Aplicar precios ====== */
function updateViaticosPriceView(){
  // desactiva autocompletar (opcional)
  document.getElementById('v_alim_inp')?.setAttribute('autocomplete','off');
  document.getElementById('v_trans_inp')?.setAttribute('autocomplete','off');
  document.getElementById('v_hosp_inp')?.setAttribute('autocomplete','off');

  // lee los 3 valores
  const al = parseFloat(document.getElementById('v_alim_inp')?.value || '0') || 0;
  const tr = parseFloat(document.getElementById('v_trans_inp')?.value || '0') || 0;
  const ho = parseFloat(document.getElementById('v_hosp_inp')?.value || '0') || 0;

  const idx = DESCS.indexOf('Viáticos');
  const sum = al + tr + ho;           // precio unitario de viáticos

  if (idx >= 0) {
    precioMap.set(idx, sum);          // guarda precio unitario
    recalcRow(idx);                   // recalcula su subtotal = (sum * días)
  }
}

function applyDefaultPrice(rowIndex, desc){
  const row = tbody.children[rowIndex]; if(!row) return;
  if(desc==='Viáticos'){ updateViaticosPriceView(); return; }

  if (desc === 'Puesta en marcha nocturno') {
    let price = computeDependentPriceForCond('Nocturno lun-vier/hora');
    precioMap.set(rowIndex, price || 0);

    const priceView  = row.querySelector('td:nth-child(4) .price-view');
    const priceInput = row.querySelector('td:nth-child(4) input.price-input');
    if (priceInput) priceInput.value = Math.round(price || 0);
    else if (priceView) priceView.textContent = fmtMoney(price);
    return;
  }

  const selOpt  = row.querySelector('td:nth-child(2) select');
  const selCond = row.querySelector('td:nth-child(3) select');
  const optVal  = selOpt ? selOpt.value : '';
  const condVal = selCond ? selCond.value : '';

// --- Si en "Puesta en marcha" no han elegido condición, no precargar precio
if (desc === 'Puesta en marcha' && !condVal) {
  precioMap.set(rowIndex, 0);

  const priceView  = row.querySelector('td:nth-child(4) .price-view');
  const priceInput = row.querySelector('td:nth-child(4) input.price-input');

  if (priceInput) priceInput.value = '';     // deja el input vacío
  else if (priceView) priceView.textContent = '$ 0';

  recalcRow(rowIndex);
  return;                                    // salimos sin calcular nada más
}

  // NUEVO: calcula el precio base
  let price = 0;
  if (DEPENDIENTES.has(desc)) {
    price = computeDependentPrice(desc);
  } else {
    const p = findPrice(desc, optVal, condVal);
    price = (p != null) ? p : 0;
  }

  // Si es fila editable y no hay precio directo, toma el mayor de esa descripción
  if (EDITABLE_PRICE.has(desc) && (!price || isNaN(price))) {
    const any = findAnyPriceForDesc(desc);
    if (any != null) price = any;
  }

  precioMap.set(rowIndex, price || 0);

  const priceView  = row.querySelector('td:nth-child(4) .price-view');
  const priceInput = row.querySelector('td:nth-child(4) input.price-input');

  if (priceInput) {
    priceInput.value = Math.round(price || 0);   // <— PRECARGA EN EL INPUT
  } else if (priceView) {
    priceView.textContent = fmtMoney(price);
  }

}

function applyAllDefaultPrices(){ DESCS.forEach((desc,i)=> applyDefaultPrice(i,desc)); }
function updateDependentRows(){ for(const d of DEPENDIENTES){ const i = ROW_INDEX[d]; if(i!=null) applyDefaultPrice(i, d); } }

/* ====== Cálculos ====== */
const moneyFmt = new Intl.NumberFormat('es-CO',{minimumFractionDigits:0,maximumFractionDigits:0});
function fmtMoney(n){ return '$ ' + moneyFmt.format(Math.round((n||0))); }

function recalcRow(i){
  const desc = DESCS[i];
  let precio = parseFloat(precioMap.get(i)||0);
  let qty = parseFloat(diasMap.get(i)||0);
  const sub = (precio||0)*(qty||0);
  const el  = document.getElementById('sub_'+i); if(el) el.textContent = fmtMoney(sub);
  recalcTotals();
}
function recalcTotals(){
  let subtotal=0;
  DESCS.forEach((desc,i)=>{
    let p = parseFloat(precioMap.get(i)||0);
    let q = parseFloat(diasMap.get(i)||0);
    subtotal += (p||0)*(q||0);
  });
  const idxV = ROW_INDEX['Viáticos'];
  const viatPrecio = parseFloat(precioMap.get(idxV)||0);
  const viatDias   = parseFloat(diasMap.get(idxV)||0);
  const viatTotal  = (viatPrecio||0) * (viatDias||0);
  const pillV = document.getElementById('pillViaticos');
  if (pillV) pillV.textContent = fmtMoney(viatTotal);

const pctEl  = document.getElementById('impPct');
const impPct = parseFloat(pctEl?.value || '10');
const imprev = subtotal * (isNaN(impPct) ? 0 : impPct) / 100;
const total  = subtotal + imprev;

const pillLbl = document.getElementById('pillImprevLabel');
if (pillLbl && !isNaN(impPct)) pillLbl.textContent = `Imprevistos (${impPct}%):`;

  document.getElementById('impPct')?.addEventListener('input', recalcTotals);
  document.getElementById('subtotalView').textContent=fmtMoney(subtotal);
  document.getElementById('imprevView').textContent=fmtMoney(imprev);
  document.getElementById('totalView').textContent=fmtMoney(total);
  document.getElementById('pillSubtotal').textContent=fmtMoney(subtotal);
  document.getElementById('pillImprev').textContent=fmtMoney(imprev);
  document.getElementById('pillTotal').textContent=fmtMoney(total);
}

/* ====== Validación mínimos ====== */
function validar(){
  const req = [
    { el: document.getElementById('tipoDoc'),   name: 'Tipo' },
    { el: document.getElementById('nombreDoc'), name: 'Nombre' },
    { el: document.getElementById('ingeniero'), name: 'Ingeniero' },
    { el: document.getElementById('alcance'),   name: 'Alcance' },
    { el: document.getElementById('cliente'),   name: 'Cliente' },
  ];

  // limpia estados previos
  req.forEach(({el}) => el?.classList.remove('error'));

  const faltantes = [];
  if (!req[0].el.value)                         { faltantes.push(req[0].name); req[0].el.classList.add('error'); }
  if (!req[1].el.value.trim())                  { faltantes.push(req[1].name); req[1].el.classList.add('error'); }
  if (!req[2].el.value.trim())                  { faltantes.push(req[2].name); req[2].el.classList.add('error'); }
  if (!req[3].el.value.trim())                  { faltantes.push(req[3].name); req[3].el.classList.add('error'); }
  if (!req[4].el.value.trim()) { faltantes.push(req[4].name); req[4].el.classList.add('error'); } // ← NUEVO

  const warnBox = document.getElementById('validacion');

  if (faltantes.length){
    warnBox.style.display = 'block';
    warnBox.textContent = 'Completa los siguientes campos antes de descargar: ' + faltantes.join(', ') + '.';
    // lleva al primer campo con error
    const firstErr = document.querySelector('.error');
    if (firstErr) firstErr.scrollIntoView({ behavior:'smooth', block:'center' });
    return false;
  }

  warnBox.style.display = 'none';
  warnBox.textContent = '';
  return true;
}

async function downloadExcelWithFilePicker(blob, fileName) {
  try {
    if ('showSaveFilePicker' in window) {
      const handle = await window.showSaveFilePicker({
        suggestedName: fileName,
        types: [{
          description: 'Archivo Excel',
          accept: {'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']}
        }]
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
      return true;
    }
    return false;
  } catch (err) {
    if (err?.name !== 'AbortError') console.error('Error al guardar:', err);
    return false;
  }
}

function downloadExcelWithFallback(blob, fileName) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = fileName;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

function postDownloadToParent(blob, fileName, mime){
  try{
    if (window.parent && window.parent !== window) {
      if (blob?.arrayBuffer) {
        blob.arrayBuffer().then(buf=>{
          window.parent.postMessage({
            __ingetes_download:true,
            fileName,
            mime: mime || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            buffer: buf
          }, '*');
        });
        return true;
      }
    }
  }catch(_){}
  return false;
}

// === Reinicio de formulario y tabla (como en Word) ===
function resetCotizacion(ev){
  ev?.preventDefault?.();

  // 1) Campos obligatorios
  const tipoSel   = document.getElementById('tipoDoc');
  const nombreInp = document.getElementById('nombreDoc');
  const ingInp    = document.getElementById('ingeniero');
  const alcInp    = document.getElementById('alcance');
  const warnBox   = document.getElementById('validacion');
  const impPctEl  = document.getElementById('impPct');
  const clienteInp = document.getElementById('cliente');

  if (tipoSel)   tipoSel.selectedIndex = 0;
  if (nombreInp) nombreInp.value = '';
  if (ingInp)    ingInp.value = '';
  if (alcInp)    alcInp.value = '';
  if (clienteInp) clienteInp.value = '';

  // Quita cualquier borde rojo previo
  document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

  // % de imprevistos por defecto
  if (impPctEl) impPctEl.value = 10;

  // 2) Limpiar estado interno
  if (typeof diasMap   !== 'undefined') diasMap.clear();
  if (typeof precioMap !== 'undefined') precioMap.clear();

  // 3) Limpiar filas de la tabla (selects, inputs, subtotales, viáticos)
  const tbody = document.querySelector('#tabla tbody');
  if (tbody){
    [...tbody.children].forEach((tr) => {
      const selOpt  = tr.querySelector('td:nth-child(2) select');
      const selCond = tr.querySelector('td:nth-child(3) select');
      if (selOpt)  selOpt.selectedIndex  = 0;
      if (selCond) selCond.selectedIndex = 0;

      const priceInp  = tr.querySelector('td:nth-child(4) input.price-input');
      const priceView = tr.querySelector('td:nth-child(4) .price-view');
      if (priceInp)  priceInp.value = '';
      if (priceView) priceView.textContent = '$ 0';

      const vAl = tr.querySelector('#v_alim_inp');
      const vTr = tr.querySelector('#v_trans_inp');
      const vHo = tr.querySelector('#v_hosp_inp');
      if (vAl) vAl.value = 0;
      if (vTr) vTr.value = 0;
      if (vHo) vHo.value = 0;

      const inDias = tr.querySelector('td:nth-child(5) input[type=number]');
      if (inDias) inDias.value = '';

      const subSpan = tr.querySelector('td:nth-child(6) span');
      if (subSpan) subSpan.textContent = '$ 0';
    });
  }

  // 4) Refrescar badges y totales
  if (typeof toggleHorasBadgesAll === 'function') toggleHorasBadgesAll();
  if (typeof updateViaticosPriceView === 'function') updateViaticosPriceView();
  if (typeof updateDependentRows === 'function') updateDependentRows();
  if (typeof recalcTotals === 'function') recalcTotals();

  // 5) Aviso de reinicio
alert('Formulario reiniciado. Puedes comenzar una nueva cotización.');
}

// Listener del botón "Reiniciar"
document.getElementById('btnReset')?.addEventListener('click', resetCotizacion);

/* ====== Descargar Excel (solo filas con selección) ====== */
// REEMPLAZA COMPLETO este bloque por el siguiente
document.getElementById('btnDescargar').addEventListener('click', async () => {
  try {
    // --- Validación mínima del formulario (si la tienes) ---
    if (typeof validar === 'function' && !validar()) return;
    if (typeof ExcelJS === 'undefined' || !ExcelJS.Workbook) {
      alert('No se pudo cargar ExcelJS.'); return;
    }

    /* =====================================================
       Helpers
    ===================================================== */
    const thin   = { style:'thin', color:{ argb:'FF000000' } };
    const box    = { top:thin, left:thin, bottom:thin, right:thin };
    const yellow = { type:'pattern', pattern:'solid', fgColor:{ argb:'FF9DC3E6' } };

    const A1 = n => { let s=''; while(n){ const m=(n-1)%26; s=String.fromCharCode(65+m)+s; n=(n-1)/26|0; } return s; };
    const ref = (r1,c1,r2,c2) => `${A1(c1)}${r1}:${A1(c2)}${r2}`;
    const safeMerge = (ws, r1,c1,r2,c2) => { const r = ref(r1,c1,r2,c2); try{ ws.unMergeCells(r); }catch(_){} ws.mergeCells(r); };

    async function saveBlob(blob, name){
      try {
        if ('showSaveFilePicker' in window) {
          const handle = await window.showSaveFilePicker({
            suggestedName: name,
            types: [{ description:'Excel', accept:{'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx']} }]
          });
          const w = await handle.createWritable(); await w.write(blob); await w.close(); return;
        }
      } catch(_) {}
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = name;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* =====================================================
       1) Lee UI
    ===================================================== */
    const tipoVal    = (document.getElementById('tipoDoc') || {}).value || '';
    const nombreVal  = (document.getElementById('nombreDoc') || {}).value || '';
    const alcanceVal = (document.getElementById('alcance')  || {}).value || '';
    const ingVal     = (document.getElementById('ingeniero')|| {}).value || '';
    const impPct     = Number(((document.getElementById('impPct') || {}).value) || 10);
    const clienteVal = (document.getElementById('cliente') || {}).value || '';

    /* =====================================================
       2) Arma AOA (sin filas en blanco)
          Fila 1: TIPO
          Fila 2: NOMBRE
          Fila 3: ALCANCE
          Fila 4: INGENIERO...
          Fila 5: Cabecera de la tabla
    ===================================================== */
    const rows = [
      ['TIPO',    tipoVal],
      ['NOMBRE DEL CLIENTE', clienteVal],
      ['NOMBRE DEL ' + (tipoVal || 'SERVICIO/PROYECTO').toUpperCase(),  nombreVal],
      ['ALCANCE', alcanceVal],
      ['INGENIERO QUE EJECUTA EL ' + (tipoVal || 'SERVICIO/PROYECTO').toUpperCase(), ingVal],
      ['DESCRIPCIÓN','OPCIÓN','CONDICIÓN','PRECIO','DÍAS','SUBTOTAL']
    ];

    const tbody = document.querySelector('#tabla tbody');
    const dataRows = [];
    (DESCS || []).forEach((desc, i) => {
      const tr = tbody?.children[i]; if (!tr) return;
      const selOpt  = tr.querySelector('td:nth-child(2) select');
      const selCond = tr.querySelector('td:nth-child(3) select');
      const inDias  = tr.querySelector('td:nth-child(5) input[type=number]');

      const opt  = selOpt && selOpt.value ? selOpt.value : '';
      const cond = selCond && selCond.value ? selCond.value : '';
      const p    = Number((typeof precioMap!=='undefined' && precioMap.get(i)) || 0);
      const q    = Number((inDias && inDias.value) ? inDias.value : 0);
      const sub  = (p||0) * (q||0);

      const include = (opt!=='' || cond!=='' || q>0);
      if (include) dataRows.push([desc, opt, cond, p, q, sub]);
    });
    dataRows.forEach(r => rows.push(r));

    /* =====================================================
       3) Libro y hoja INGENIERIA
    ===================================================== */
    const wb = new ExcelJS.Workbook();
    const ws = wb.addWorksheet('INGENIERIA');
    rows.forEach(r => ws.addRow(r));
    ws.columns = [{width:33},{width:33},{width:30},{width:14},{width:10},{width:16}];

    // Filas 1–4: título en A, valor en B:F combinado
    for (let r=1; r<=5; r++){
      ws.getCell(r,1).font = { bold:true };
      safeMerge(ws, r,2, r,6);
      ws.getCell(r,2).alignment = { vertical:'middle', horizontal:'left', wrapText:true };
      for (let c=1; c<=6; c++) ws.getCell(r,c).border = box;
    }

    // Cabecera de la tabla (fila 5)
    const headerRow = 6;
    for (let c=1; c<=6; c++){
      const cell = ws.getCell(headerRow, c);
      cell.font = { bold:true };
      cell.fill = yellow;
      cell.border = box;
    }

    // Datos (desde fila 6) + cuadricula + fórmula F=D*E
    const firstData = headerRow + 1;
    const items = dataRows.length;
    if (items > 0){
      for (let r=firstData; r<firstData+items; r++){
        for (let c=1; c<=6; c++) ws.getCell(r,c).border = box;
        ws.getCell(r,6).value  = { formula:`D${r}*E${r}` };
        ws.getCell(r,6).numFmt = '"$" #,##0';
      }
    }

    // Totales pegados inmediatamente bajo los datos
    const lastData   = firstData + items - 1;
    const rSubtotal  = (items>0) ? lastData + 1 : headerRow + 1;
    const rImprev    = rSubtotal + 1;
    const rTotalPlus = rSubtotal + 2;

    ws.getCell(rSubtotal,6).value  = (items>0) ? { formula:`SUM(F${firstData}:F${lastData})` } : 0;
    ws.getCell(rSubtotal,6).numFmt = '"$" #,##0';
    ws.getCell(rImprev,6).value    = { formula:`F${rSubtotal}*(${impPct}/100)` };
    ws.getCell(rImprev,6).numFmt   = '"$" #,##0';
    ws.getCell(rTotalPlus,6).value = { formula:`F${rSubtotal}+F${rImprev}` };
    ws.getCell(rTotalPlus,6).numFmt= '"$" #,##0';

    const styleTotal = (r, txt) => {
      safeMerge(ws, r,1, r,5);
      const a = ws.getCell(r,1);
      a.value = txt; a.font = { bold:true };
      a.alignment = { horizontal:'right', vertical:'middle' };
      for (let c=1; c<=6; c++){ const cc = ws.getCell(r,c); cc.border = box; cc.fill = yellow; }
    };
    styleTotal(rSubtotal,  'SUBTOTAL');
    styleTotal(rImprev,    `IMPREVISTOS (${impPct}%)`);
    styleTotal(rTotalPlus, 'TOTAL');

    /* =====================================================
       4) RESUMEN PARA VENTA (con cuadricula)
    ===================================================== */
    const VENTA_SET = new Set([
      'Programación','Visualización','Configuración','Especializados',
      'Pruebas FAT','Pruebas SAT (PLC/CCM/HMI)','Puesta en marcha','Capacitación de operación'
    ]);

    const ventaRefs = [];
    for (let i=0; i<items; i++){
      const d = dataRows[i][0];
      if (VENTA_SET.has(d)) ventaRefs.push(firstData + i);
    }

    const resStart = rTotalPlus + 2;                  // una fila libre entre totales y el resumen
    safeMerge(ws, resStart,1, resStart,3);
    ws.getCell(resStart,1).value = 'RESUMEN PARA VENTA';
    ws.getCell(resStart,1).font  = { bold:true };

    const resHeader = resStart + 1;
    ws.getCell(resHeader,1).value = 'DESCRIPCION';
    ws.getCell(resHeader,2).value = 'DIAS';
    ws.getCell(resHeader,1).font = ws.getCell(resHeader,2).font = { bold:true };
    ws.getCell(resHeader,1).border = box;
    ws.getCell(resHeader,2).border = box;

    const resDataStart = resHeader + 1;
    if (ventaRefs.length === 0){
      ws.getCell(resDataStart,1).border = box;
      ws.getCell(resDataStart,2).border = box;
    } else {
      for (let k=0; k<ventaRefs.length; k++){
        const r  = resDataStart + k;
        const ir = ventaRefs[k];
        ws.getCell(r,1).value = { formula:`A${ir}` };
        ws.getCell(r,2).value = { formula:`E${ir}` };
        ws.getCell(r,1).border = box;
        ws.getCell(r,2).border = box;
      }
    }

    /* =====================================================
       5) Hoja VENTA
    ===================================================== */
    const wv = wb.addWorksheet('VENTA');
    wv.columns = [
      {width:3},{width:3},{width:3},
      {width:6},{width:8},{width:75},
      {width:18},{width:18}
    ];
    const yellow2 = { type:'pattern', pattern:'solid', fgColor:{ argb:'FF9DC3E6' } };
    const box2    = { top:thin, left:thin, bottom:thin, right:thin };
    const safeMergeV = (ws2,r1,c1,r2,c2)=>{ const r=ref(r1,c1,r2,c2); try{ws2.unMergeCells(r);}catch(_){ } ws2.mergeCells(r); };

    safeMergeV(wv,3,4,3,8);
    for (let c=4;c<=8;c++){ const cell = wv.getCell(3,c); cell.fill = yellow2; cell.border = box2; }
    ['ITEM','CANT','DESCRIPCION','V/UNIT','V/TOTAL'].forEach((t,i)=>{
      const cell = wv.getCell(4,4+i); cell.value=t; cell.fill=yellow2; cell.font={bold:true};
      cell.alignment = { vertical:'middle', horizontal:'center', wrapText:true }; cell.border = box2;
    });

    // Alcance está SIEMPRE en fila 3 (B3) por el nuevo layout
    const alcRow = 4;
    const rr = 5;
    const totalLink = `INGENIERIA!F${rTotalPlus}`;

    if (items>0){
      wv.getCell(rr,4).value = 1; wv.getCell(rr,5).value = 1;
      wv.getCell(rr,4).alignment = { vertical:'middle', horizontal:'center' };
      wv.getCell(rr,5).alignment = { vertical:'middle', horizontal:'center' };

      let descExpr = `"Alcance: "&INGENIERIA!B${alcRow}`;
      if (ventaRefs.length>0){
        const lastRes = resDataStart + ventaRefs.length - 1;
        descExpr += '&CHAR(10)&CHAR(10)';
        for (let r=resDataStart; r<=lastRes; r++){
          descExpr += `&INGENIERIA!A${r}&" - "&INGENIERIA!B${r}&" dias"`;
          if (r<lastRes) descExpr += '&CHAR(10)';
        }
      }
      wv.getCell(rr,6).value = { formula: descExpr };
      wv.getCell(rr,6).alignment = { vertical:'top', horizontal:'left', wrapText:true };

      wv.getCell(rr,7).value = { formula: totalLink };
      wv.getCell(rr,8).value = { formula: totalLink };
      wv.getCell(rr,7).numFmt=wv.getCell(rr,8).numFmt='"$" #,##0';
      wv.getCell(rr,7).alignment={vertical:'middle',horizontal:'right'};
      wv.getCell(rr,8).alignment={vertical:'middle',horizontal:'right'};
      for (let c=4;c<=8;c++) wv.getCell(rr,c).border = box2;
    } else {
      for (let c=4;c<=8;c++){ const z=wv.getCell(rr,c); z.value=''; z.border=box2; }
    }

    const rTot = rr + 1;
    safeMergeV(wv, rTot,4, rTot,7);
    wv.getCell(rTot,4).value='TOTAL';
    wv.getCell(rTot,4).alignment={horizontal:'right',vertical:'middle'}; wv.getCell(rTot,4).font={bold:true};
    wv.getCell(rTot,8).value=(items>0)?{formula: totalLink}:0; wv.getCell(rTot,8).numFmt='"$" #,##0';
    for (let c=4;c<=8;c++){ const t=wv.getCell(rTot,c); t.fill = yellow2; t.border = box2; }

    const rIva = rTot + 1;
    safeMergeV(wv, rIva,4, rIva,8);
    wv.getCell(rIva,4).value='IVA NO INCLUIDO';
    wv.getCell(rIva,4).alignment={horizontal:'center',vertical:'middle'}; wv.getCell(rIva,4).font={bold:true};
    for (let c=4;c<=8;c++){ const iv=wv.getCell(rIva,c); iv.fill = yellow2; iv.border = box2; }

    wb.calcProperties.fullCalcOnLoad = true;

    /* =====================================================
       6) Guardar
    ===================================================== */
    const buf  = await wb.xlsx.writeBuffer({ useStyles:true });
    const blob = new Blob([buf], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    await saveBlob(blob, 'CotizacionIngenieria.xlsx');

  } catch (err) {
    console.error(err);
    alert('No se pudo generar el Excel: ' + (err?.message || err));
  }
});

/* ====== Init ====== */
renderTable();
loadPricingFromURL();
</script>
</body>
</html>
