<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cotizador r√°pido INGETES</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">
</head>
<body class="bg-gray-50">
  <div class="max-w-4xl mx-auto p-6">
    <!-- Encabezado con logo -->
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-semibold">Cotizador r√°pido INGETES</h1>
      <img src="ingetes.jpg" alt="Logo INGETES" class="h-16 w-auto">
    </div>

    <div class="bg-white rounded-2xl shadow-sm border mb-4">
      <div class="p-5 space-y-4">
        <div>
          <label class="text-sm text-gray-700">Referencia (MLFB)</label>
          <div class="flex gap-2 mt-1">
            <input id="ref" class="w-full border rounded-lg px-3 py-2" placeholder="ej. 3VA1220-5EF32-0AA0">
            <a id="mallLink" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border bg-black text-white"
               target="_blank" rel="noreferrer">üîé Buscar en Industry Mall ‚Üó</a>
          </div>
        </div>

        <div>
          <label class="text-sm text-gray-700">Descripci√≥n del producto</label>
          <textarea id="desc" rows="4" class="w-full border rounded-lg px-3 py-2"
                    placeholder="Pega aqu√≠ la descripci√≥n completa"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-700">Precio de lista</label>
            <div class="flex gap-2">
              <select id="priceMode" class="w-28 border rounded-lg px-2 py-2">
                <option value="COP">COP</option>
                <option value="USD">USD</option>
              </select>
              <input id="price" type="number" class="w-full border rounded-lg px-3 py-2">
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-700">TRM (si precio en USD)</label>
            <input id="trm" type="number" value="4250" class="w-full border rounded-lg px-3 py-2">
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm text-gray-700">Descuento (%)</label>
            <input id="discount" type="number" value="0" class="w-full border rounded-lg px-3 py-2">
          </div>
          <div>
            <label class="text-sm text-gray-700">Factor de utilidad (opcional)</label>
            <input id="util" type="number" step="0.01" value="1.00" class="w-full border rounded-lg px-3 py-2">
          </div>
          <div>
            <label class="text-sm text-gray-700">Env√≠o (COP)</label>
            <input id="shipping" type="number" value="0" class="w-full border rounded-lg px-3 py-2">
          </div>
        </div>

        <div>
          <label class="text-sm text-gray-700">Disponibilidad</label>
          <input id="lead" class="w-full border rounded-lg px-3 py-2" placeholder="ej. 2-3 d√≠as h√°biles o 45">
        </div>

        <div>
          <label class="text-sm text-gray-700">Notas</label>
          <textarea id="notes" rows="3" class="w-full border rounded-lg px-3 py-2"
                    placeholder="Escribe aqu√≠ notas adicionales para la cotizaci√≥n"></textarea>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border">
      <div class="p-5 space-y-3">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div class="rounded-xl border p-3">
            <div class="text-[11px] uppercase tracking-wide text-gray-500">Precio base COP</div>
            <div id="baseCop" class="text-base mt-1 font-medium">‚Äî</div>
          </div>
          <div class="rounded-xl border p-3">
            <div class="text-[11px] uppercase tracking-wide text-gray-500">Precio de venta (desc/utilidad)</div>
            <div id="saleAfter" class="text-base mt-1 font-medium">‚Äî</div>
          </div>
          <div class="rounded-xl border p-3">
            <div class="text-[11px] uppercase tracking-wide text-gray-500">+ Env√≠o</div>
            <div id="shipVal" class="text-base mt-1 font-medium">‚Äî</div>
          </div>
          <div class="rounded-xl border p-3">
            <div class="text-[11px] uppercase tracking-wide text-gray-500">Total antes de IVA</div>
            <div id="totalBefore" class="text-base mt-1 font-medium">‚Äî</div>
          </div>
        </div>

        <div class="text-sm font-medium mt-2">Previsualizaci√≥n (formato final)</div>
        <pre id="preview" class="text-sm whitespace-pre-wrap leading-6 border rounded-xl p-3 bg-white">(Completa referencia, descripci√≥n y valores para ver el bloque final)</pre>

        <div class="flex flex-wrap gap-2 items-center">
          <button id="copyBtn" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg border bg-black text-white">üìã Copiar</button>
          <button id="downloadBtn" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg border">‚¨áÔ∏è Descargar .txt</button>
          <button id="resetBtn" class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg border">üîÑ Reiniciar</button>
          <div id="copyMsg" class="text-sm ml-auto"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function moneyCOP(v) {
    if (v == null || isNaN(v)) return "‚Äî";
    return v.toLocaleString("es-CO", { style: "currency", currency: "COP", maximumFractionDigits: 0 });
  }

  function cleanDesc(text) {
    if (!text) return "";
    let s = String(text);
    s = s.replace(/\r\n|\r|\n/g, "\n");
    s = s.replace(/\\+n/gi, "\n");
    s = s.replace(/&#10;|&#x0a;|%0a/gi, "\n");
    s = s.replace(/\\+t/gi, " ");
    s = s.split("\n").map(line => line.trim()).join("\n").replace(/ {2,}/g, " ").trim();
    return s;
  }

  function normalizeAvailability(input) {
    const raw = (input || "").trim();
    if (!raw) return "(sin confirmar)";
    const digits = raw.match(/\d+/g)?.map(n => parseInt(n, 10)) || [];
    const n = digits[0];
    if (!Number.isFinite(n)) return raw;
    if (n >= 1 && n <= 5) return "3-5 d√≠as. (Salvo venta previa)";
    if (n >= 30 && n <= 45) return "30-45 d√≠as. (Salvo venta previa)";
    if (n >= 46 && n <= 60) return "6 - 8 semanas";
    if (n >= 61 && n <= 80) return "8 - 10 semanas";
    if (n >= 81 && n <= 90) return "10 - 12 semanas";
    return raw;
  }

  function compute() {
    const ref = $("ref").value.trim();
    $("mallLink").href = ref ? `https://mall.industry.siemens.com/mall/en/ww/Catalog/Product/?mlfb=${encodeURIComponent(ref)}` : "#";

    const descRaw = $("desc").value;
    const desc = cleanDesc(descRaw);

    const priceMode = $("priceMode").value;
    const price = Number($("price").value || 0);
    const trm = Number($("trm").value || 0);
    const discount = Number($("discount").value || 0);
    const util = Number($("util").value || 1);
    const shipping = Number($("shipping").value || 0);
    const lead = $("lead").value;
    const notes = $("notes").value.trim();

    const baseCOP = priceMode === "USD" ? (price * trm) : price;
    const afterDisc = baseCOP ? baseCOP * (1 - discount / 100) : null;
    const saleAfter = afterDisc != null ? afterDisc * (util || 1) : null;
    const totalBeforeVAT = saleAfter != null ? Math.max(0, Math.round(saleAfter + (shipping || 0))) : null;

    $("baseCop").textContent = moneyCOP(baseCOP || null);
    $("saleAfter").textContent = moneyCOP(saleAfter != null ? saleAfter : null);
    $("shipVal").textContent = moneyCOP(shipping || null);
    $("totalBefore").textContent = moneyCOP(totalBeforeVAT != null ? totalBeforeVAT : null);

    const availability = normalizeAvailability(lead);
    const notesPart = notes ? `\n\nNOTAS: ${notes}` : "";
    const block = (ref && desc && totalBeforeVAT != null)
      ? `${ref}\n${desc}\nCosto: ${moneyCOP(totalBeforeVAT)} + IVA\nDisponibilidad: ${availability}${notesPart}`
      : "(Completa referencia, descripci√≥n y valores para ver el bloque final)";
    $("preview").textContent = block;

    return block !== "(Completa referencia, descripci√≥n y valores para ver el bloque final)" ? block : "";
  }

  async function copyBlock() {
    const txt = compute();
    if (!txt) return;
    $("copyMsg").textContent = "";
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(txt);
        $("copyMsg").textContent = "‚úÖ Copiado al portapapeles";
        $("copyMsg").className = "text-sm ml-auto text-emerald-600";
        return;
      }
      throw new Error("clipboard not available");
    } catch {
      $("copyMsg").textContent = "‚ö†Ô∏è Copia manual: selecciona el texto y presiona Ctrl/Cmd+C";
      $("copyMsg").className = "text-sm ml-auto text-amber-600";
    }
  }

  function downloadTxt() {
    const txt = compute();
    if (!txt) return;
    const ref = $("ref").value.trim().replace(/[^A-Za-z0-9_-]+/g, "-") || "cotizacion";
    const blob = new Blob([txt], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `cotizacion-${ref}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function resetAll() {
    $("ref").value = "";
    $("desc").value = "";
    $("priceMode").value = "COP";
    $("price").value = "";
    $("trm").value = "4250";
    $("discount").value = "0";
    $("util").value = "1.00";
    $("shipping").value = "0";
    $("lead").value = "";
    $("notes").value = "";
    $("copyMsg").textContent = "";
    $("copyMsg").className = "text-sm ml-auto";
    compute();
  }

  ["ref","desc","priceMode","price","trm","discount","util","shipping","lead","notes"].forEach(id => {
    $(id).addEventListener("input", compute);
    $(id).addEventListener("change", compute);
  });
  $("copyBtn").addEventListener("click", copyBlock);
  $("downloadBtn").addEventListener("click", downloadTxt);
  $("resetBtn").addEventListener("click", resetAll);
  $("mallLink").addEventListener("click", (e) => {
    if (!$("ref").value.trim()) e.preventDefault();
  });

  compute();
</script>
</body>
</html>
